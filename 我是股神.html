<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯è‚¡ç¥ - æ¨¡æ‹ŸæŠ•èµ„äº¤æ˜“å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .header {
            background: linear-gradient(135deg, #ff5f6d, #ffc371);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: bold;
        }
        
        .account-info {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .account-balance {
            font-size: 16px;
            font-weight: bold;
            color: #ff5f6d;
        }
        
        .account-profit {
            font-size: 14px;
        }
        
        .profit-up {
            color: #f44336;
        }
        
        .profit-down {
            color: #4CAF50;
        }
        
        .nav-tabs {
            display: flex;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: #666;
        }
        
        .nav-tab.active {
            color: #ff5f6d;
            border-bottom: 2px solid #ff5f6d;
        }
        
        .tab-content {
            display: none;
            padding: 10px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stock-list, .fund-list, .futures-list, .bond-list, .currency-list {
            margin-bottom: 10px;
        }
        
        .stock-item, .fund-item, .futures-item, .bond-item, .currency-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 10px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .stock-info, .fund-info, .futures-info, .bond-info, .currency-info {
            flex: 1;
        }
        
        .stock-name, .fund-name, .futures-name, .bond-name, .currency-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .stock-code, .fund-code, .futures-code, .bond-code, .currency-code {
            font-size: 12px;
            color: #999;
        }
        
        .stock-price, .fund-price, .futures-price, .bond-price, .currency-price {
            text-align: right;
            font-weight: bold;
        }
        
        .stock-change, .fund-change, .futures-change, .bond-change, .currency-change {
            text-align: right;
            font-size: 12px;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            border: none;
            cursor: pointer;
        }
        
        .btn-buy {
            background-color: #f44336;
            color: white;
        }
        
        .btn-sell {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-long {
            background-color: #f44336;
            color: white;
        }
        
        .btn-short {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-loan {
            background-color: #9C27B0;
            color: white;
        }
        
        .btn-repay {
            background-color: #FF9800;
            color: white;
        }
        
        .task-item {
            padding: 12px 10px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-info {
            flex: 1;
        }
        
        .task-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .task-desc {
            font-size: 12px;
            color: #999;
        }
        
        .task-reward {
            color: #ff5f6d;
            font-weight: bold;
        }
        
        .position-item {
            padding: 12px 10px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .position-name {
            font-weight: bold;
        }
        
        .position-code {
            font-size: 12px;
            color: #999;
        }
        
        .position-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .position-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }
        
        .position-actions .btn {
            margin-left: 5px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            background: linear-gradient(135deg, #ff5f6d, #ffc371);
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-radio-group {
            display: flex;
            margin-bottom: 15px;
        }
        
        .form-radio-item {
            flex: 1;
            text-align: center;
        }
        
        .form-radio-item input {
            margin-right: 5px;
        }
        
        .modal-footer {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #eee;
        }
        
        .footer-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: #fff;
            border-top: 1px solid #eee;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
        }
        
        .footer-nav-item {
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        
        .footer-nav-item.active {
            color: #ff5f6d;
        }
        
        .footer-nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        /* Kçº¿å›¾æ ·å¼ */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 10px 0;
            position: relative;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        
        .chart-name {
            font-weight: bold;
        }
        
        .chart-period {
            display: flex;
        }
        
        .chart-period-btn {
            padding: 4px 8px;
            margin-left: 5px;
            font-size: 12px;
            background-color: #eee;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .chart-period-btn.active {
            background-color: #ff5f6d;
            color: white;
        }
        
        .chart-canvas {
            width: 100%;
            height: calc(100% - 40px);
        }
        
        .chart-info {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .chart-info-item span:first-child {
            color: #999;
            margin-right: 5px;
        }
        
        /* è¯¦æƒ…é¡µæ ·å¼ */
        .detail-header {
            padding: 15px;
            background: linear-gradient(135deg, #ff5f6d, #ffc371);
            color: white;
            position: relative;
        }
        
        .detail-back {
            position: absolute;
            left: 15px;
            top: 15px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .detail-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .detail-code {
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .detail-price {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .detail-change {
            text-align: center;
            font-size: 16px;
        }
        
        .detail-section {
            margin: 15px 0;
            padding: 0 10px;
        }
        
        .detail-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .detail-actions .btn {
            width: 48%;
            padding: 10px;
        }
        
        /* é‡Œç¨‹ç¢‘æ ·å¼ */
        .milestone-item {
            padding: 12px 10px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .milestone-info {
            flex: 1;
        }
        
        .milestone-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .milestone-desc {
            font-size: 12px;
            color: #999;
        }
        
        .milestone-progress {
            height: 5px;
            background-color: #eee;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .milestone-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #ff5f6d, #ffc371);
            border-radius: 3px;
        }
        
        .milestone-reward {
            color: #ff5f6d;
            font-weight: bold;
        }
        
        /* è´¦æˆ·é¡µæ ·å¼ */
        .account-section {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .account-section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .account-loan-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .account-loan-amount {
            font-weight: bold;
            color: #9C27B0;
        }
        
        @media (max-width: 375px) {
            .stock-name, .fund-name, .futures-name, .bond-name, .currency-name {
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div class="header">
            <h1>æˆ‘æ˜¯è‚¡ç¥</h1>
        </div>
        
        <div class="account-info">
            <div>
                <div>æ€»èµ„äº§</div>
                <div class="account-balance" id="total-assets">Â¥10,000.00</div>
            </div>
            <div>
                <div>ä»Šæ—¥ç›ˆäº</div>
                <div class="account-profit profit-up" id="today-profit">+Â¥0.00 (0.00%)</div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="stocks">è‚¡ç¥¨</div>
            <div class="nav-tab" data-tab="funds">åŸºé‡‘</div>
            <div class="nav-tab" data-tab="futures">æœŸè´§</div>
            <div class="nav-tab" data-tab="bonds">å›½å€º</div>
            <div class="nav-tab" data-tab="currency">è´§å¸</div>
        </div>
        
        <div class="tab-content active" id="stocks-tab">
            <div class="stock-list" id="stock-list">
                <!-- è‚¡ç¥¨åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="funds-tab">
            <div class="fund-list" id="fund-list">
                <!-- åŸºé‡‘åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="futures-tab">
            <div class="futures-list" id="futures-list">
                <!-- æœŸè´§åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="bonds-tab">
            <div class="bond-list" id="bond-list">
                <!-- å›½å€ºåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="currency-tab">
            <div class="currency-list" id="currency-list">
                <!-- è´§å¸åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="positions-tab">
            <div class="position-list" id="position-list">
                <!-- æŒä»“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="tasks-tab">
            <div class="task-list" id="task-list">
                <!-- ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="milestones-tab">
            <div class="milestone-list" id="milestone-list">
                <!-- é‡Œç¨‹ç¢‘åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="tab-content" id="account-tab">
            <div class="account-section">
                <div class="account-section-title">è´¦æˆ·ä¿¡æ¯</div>
                <div>å¯ç”¨èµ„é‡‘: <span id="account-balance">Â¥10,000.00</span></div>
                <div>æ€»è´Ÿå€º: <span id="account-debt">Â¥0.00</span></div>
                <div>å‡€èµ„äº§: <span id="account-net-worth">Â¥10,000.00</span></div>
            </div>
            
            <div class="account-section">
                <div class="account-section-title">å€Ÿè´·ç®¡ç†</div>
                <button class="btn btn-loan" id="btn-loan">ç”³è¯·è´·æ¬¾</button>
                <button class="btn btn-repay" id="btn-repay">å¿è¿˜è´·æ¬¾</button>
            </div>
            
            <div class="account-section">
                <div class="account-section-title">äº¤æ˜“ç»Ÿè®¡</div>
                <div>æ€»äº¤æ˜“æ¬¡æ•°: <span id="total-trades">0</span></div>
                <div>ç´¯è®¡ç›ˆåˆ©: <span id="total-profit">Â¥0.00</span></div>
            </div>
        </div>
        
        <div class="footer-nav">
            <div class="footer-nav-item active" data-tab="market">
                <div class="footer-nav-icon">ğŸ“ˆ</div>
                <div>è¡Œæƒ…</div>
            </div>
            <div class="footer-nav-item" data-tab="positions">
                <div class="footer-nav-icon">ğŸ’°</div>
                <div>æŒä»“</div>
            </div>
            <div class="footer-nav-item" data-tab="tasks">
                <div class="footer-nav-icon">ğŸ¯</div>
                <div>ä»»åŠ¡</div>
            </div>
            <div class="footer-nav-item" data-tab="milestones">
                <div class="footer-nav-icon">ğŸ†</div>
                <div>é‡Œç¨‹ç¢‘</div>
            </div>
            <div class="footer-nav-item" data-tab="account">
                <div class="footer-nav-icon">ğŸ‘¤</div>
                <div>æˆ‘çš„</div>
            </div>
        </div>
    </div>
    
    <!-- è¯¦æƒ…é¡µå®¹å™¨ (åˆå§‹éšè—) -->
    <div class="container" id="detail-container" style="display: none;">
        <div class="detail-header">
            <div class="detail-back" id="detail-back">â†</div>
            <div class="detail-title" id="detail-title">è´µå·èŒ…å°</div>
            <div class="detail-code" id="detail-code">SH600519</div>
            <div class="detail-price" id="detail-price">1720.50</div>
            <div class="detail-change profit-up" id="detail-change">+1.23 (0.07%)</div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-name">Kçº¿å›¾</div>
                <div class="chart-period">
                    <button class="chart-period-btn active" data-period="1d">æ—¥çº¿</button>
                    <button class="chart-period-btn" data-period="1w">å‘¨çº¿</button>
                    <button class="chart-period-btn" data-period="1m">æœˆçº¿</button>
                </div>
            </div>
            <canvas class="chart-canvas" id="kline-chart"></canvas>
            <div class="chart-info">
                <div class="chart-info-item">
                    <span>å¼€:</span><span id="chart-open">1720.50</span>
                </div>
                <div class="chart-info-item">
                    <span>é«˜:</span><span id="chart-high">1725.60</span>
                </div>
                <div class="chart-info-item">
                    <span>ä½:</span><span id="chart-low">1718.30</span>
                </div>
                <div class="chart-info-item">
                    <span>æ”¶:</span><span id="chart-close">1720.50</span>
                </div>
                <div class="chart-info-item">
                    <span>æ¶¨:</span><span id="chart-up" style="color:#f44336">0</span>
                </div>
                <div class="chart-info-item">
                    <span>è·Œ:</span><span id="chart-down" style="color:#4CAF50">0</span>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
            <div id="detail-info">è´µå·èŒ…å°é…’è‚¡ä»½æœ‰é™å…¬å¸ä¸»è¦ä¸šåŠ¡æ˜¯èŒ…å°é…’åŠç³»åˆ—é…’çš„ç”Ÿäº§ä¸é”€å”®ã€‚ä¸»å¯¼äº§å“"è´µå·èŒ…å°é…’"æ˜¯ä¸–ç•Œä¸‰å¤§è’¸é¦åé…’ä¹‹ä¸€ã€‚</div>
        </div>
        
        <div class="detail-actions">
            <button class="btn btn-long" id="detail-buy-long">ä¹°æ¶¨</button>
            <button class="btn btn-short" id="detail-buy-short">ä¹°è·Œ</button>
            <button class="btn btn-sell" id="detail-sell">å–å‡º</button>
        </div>
    </div>
    
    <!-- äº¤æ˜“æ¨¡æ€æ¡† -->
    <div class="modal" id="trade-modal">
        <div class="modal-content">
            <div class="modal-header" id="trade-modal-title">ä¹°å…¥è‚¡ç¥¨</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="trade-name">åç§°</label>
                    <input type="text" class="form-control" id="trade-name" readonly>
                </div>
                <div class="form-group">
                    <label for="trade-code">ä»£ç </label>
                    <input type="text" class="form-control" id="trade-code" readonly>
                </div>
                <div class="form-group">
                    <label for="trade-price">ä»·æ ¼</label>
                    <input type="text" class="form-control" id="trade-price" readonly>
                </div>
                <div class="form-radio-group" id="trade-direction-group">
                    <div class="form-radio-item">
                        <input type="radio" id="trade-direction-long" name="trade-direction" value="long" checked>
                        <label for="trade-direction-long">ä¹°æ¶¨</label>
                    </div>
                    <div class="form-radio-item">
                        <input type="radio" id="trade-direction-short" name="trade-direction" value="short">
                        <label for="trade-direction-short">ä¹°è·Œ</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="trade-amount">æ•°é‡</label>
                    <input type="number" class="form-control" id="trade-amount" min="1" value="100">
                </div>
                <div class="form-group">
                    <label for="trade-total">æ€»ä»·</label>
                    <input type="text" class="form-control" id="trade-total" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="trade-cancel">å–æ¶ˆ</button>
                <button class="btn btn-buy" id="trade-confirm">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- è´·æ¬¾æ¨¡æ€æ¡† -->
    <div class="modal" id="loan-modal">
        <div class="modal-content">
            <div class="modal-header">ç”³è¯·è´·æ¬¾</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loan-amount">è´·æ¬¾é‡‘é¢</label>
                    <input type="number" class="form-control" id="loan-amount" min="1" value="1000">
                </div>
                <div class="form-group">
                    <label for="loan-interest">åˆ©ç‡ (æ¯æ—¥ 0.1%)</label>
                    <input type="text" class="form-control" id="loan-interest" value="0.1%" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="loan-cancel">å–æ¶ˆ</button>
                <button class="btn btn-loan" id="loan-confirm">ç¡®è®¤è´·æ¬¾</button>
            </div>
        </div>
    </div>
    
    <!-- è¿˜æ¬¾æ¨¡æ€æ¡† -->
    <div class="modal" id="repay-modal">
        <div class="modal-content">
            <div class="modal-header">å¿è¿˜è´·æ¬¾</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="repay-amount">è¿˜æ¬¾é‡‘é¢ (æœ€å¤§: <span id="max-repay">0</span>)</label>
                    <input type="number" class="form-control" id="repay-amount" min="1" value="0">
                </div>
                <div class="account-loan-info">
                    å½“å‰è´·æ¬¾æ€»é¢: <span class="account-loan-amount" id="current-loan">Â¥0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="repay-cancel">å–æ¶ˆ</button>
                <button class="btn btn-repay" id="repay-confirm">ç¡®è®¤è¿˜æ¬¾</button>
            </div>
        </div>
    </div>
    
    <!-- ä»»åŠ¡å¥–åŠ±æ¨¡æ€æ¡† -->
    <div class="modal" id="reward-modal">
        <div class="modal-content">
            <div class="modal-header">ä»»åŠ¡å®Œæˆ</div>
            <div class="modal-body">
                <p id="reward-message">æ­å–œæ‚¨å®Œæˆä»»åŠ¡ï¼Œè·å¾—å¥–åŠ± Â¥1000</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="reward-close">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- é‡Œç¨‹ç¢‘å¥–åŠ±æ¨¡æ€æ¡† -->
    <div class="modal" id="milestone-modal">
        <div class="modal-content">
            <div class="modal-header">é‡Œç¨‹ç¢‘è¾¾æˆ</div>
            <div class="modal-body">
                <p id="milestone-message">æ­å–œæ‚¨è¾¾æˆé‡Œç¨‹ç¢‘ï¼Œè·å¾—å¥–åŠ± Â¥10000</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="milestone-close">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- èµ„äº§é‡ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="reset-modal">
        <div class="modal-content">
            <div class="modal-header">èµ„äº§é‡ç½®</div>
            <div class="modal-body">
                <p id="reset-message">æ‚¨çš„è´Ÿå€ºå·²è¶…è¿‡1äº¿å…ƒï¼Œç³»ç»Ÿå·²å°†æ‚¨çš„èµ„äº§é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="reset-close">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <script>
        // æ•°æ®åº“åç§°å’Œç‰ˆæœ¬
        const DB_NAME = 'StockGodDB';
        const DB_VERSION = 1;
        
        // å¯¹è±¡å­˜å‚¨åç§°
        const STORES = {
            USER_DATA: 'user_data',
            MARKET_DATA: 'market_data',
            PRICE_HISTORY: 'price_history'
        };
        
        // åˆå§‹æ•°æ®
        const defaultUserData = {
            balance: 10000,
            debt: 0,
            positions: [],
            completedTasks: [],
            completedMilestones: [],
            todayProfit: 0,
            totalTrades: 0,
            totalProfit: 0,
            lastUpdate: new Date().getTime()
        };
        
        // åˆå§‹å¸‚åœºæ•°æ®
        const defaultMarketData = {
            stocks: [
                { code: "SH600519", name: "è´µå·èŒ…å°", price: 1720.50, change: 1.23, changePercent: 0.07, info: "è´µå·èŒ…å°é…’è‚¡ä»½æœ‰é™å…¬å¸ä¸»è¦ä¸šåŠ¡æ˜¯èŒ…å°é…’åŠç³»åˆ—é…’çš„ç”Ÿäº§ä¸é”€å”®ã€‚ä¸»å¯¼äº§å“'è´µå·èŒ…å°é…’'æ˜¯ä¸–ç•Œä¸‰å¤§è’¸é¦åé…’ä¹‹ä¸€ã€‚" },
                { code: "SZ000858", name: "äº”ç²®æ¶²", price: 156.80, change: -2.30, changePercent: -1.45, info: "å®œå®¾äº”ç²®æ¶²è‚¡ä»½æœ‰é™å…¬å¸æ˜¯ä»¥äº”ç²®æ¶²åŠå…¶ç³»åˆ—é…’çš„ç”Ÿäº§ã€é”€å”®ä¸ºä¸»è¦äº§ä¸šçš„å…¬å¸ã€‚" },
                { code: "SH601318", name: "ä¸­å›½å¹³å®‰", price: 48.25, change: 0.45, changePercent: 0.94, info: "ä¸­å›½å¹³å®‰ä¿é™©(é›†å›¢)è‚¡ä»½æœ‰é™å…¬å¸æ˜¯ä¸­å›½ç¬¬ä¸€å®¶è‚¡ä»½åˆ¶ä¿é™©ä¼ä¸šï¼Œå·²å‘å±•æˆä¸ºé‡‘èä¿é™©ã€é“¶è¡Œã€æŠ•èµ„ç­‰é‡‘èä¸šåŠ¡ä¸ºä¸€ä½“çš„ç»¼åˆé‡‘èæœåŠ¡é›†å›¢ã€‚" },
                { code: "SZ000333", name: "ç¾çš„é›†å›¢", price: 56.70, change: 1.20, changePercent: 2.16, info: "ç¾çš„é›†å›¢è‚¡ä»½æœ‰é™å…¬å¸æ˜¯ä¸€å®¶é›†æ¶ˆè´¹ç”µå™¨ã€æš–é€šç©ºè°ƒã€æœºå™¨äººä¸è‡ªåŠ¨åŒ–ç³»ç»Ÿã€æ™ºèƒ½ä¾›åº”é“¾ã€èŠ¯ç‰‡äº§ä¸šã€ç”µæ¢¯äº§ä¸šçš„ç§‘æŠ€é›†å›¢ã€‚" },
                { code: "SH600036", name: "æ‹›å•†é“¶è¡Œ", price: 32.15, change: -0.25, changePercent: -0.77, info: "æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸æ˜¯ä¸­å›½ç¬¬ä¸€å®¶å®Œå…¨ç”±ä¼ä¸šæ³•äººæŒè‚¡çš„è‚¡ä»½åˆ¶å•†ä¸šé“¶è¡Œï¼Œä¹Ÿæ˜¯å›½å®¶ä»ä½“åˆ¶å¤–æ¨åŠ¨é“¶è¡Œä¸šæ”¹é©çš„ç¬¬ä¸€å®¶è¯•ç‚¹é“¶è¡Œã€‚" }
            ],
            funds: [
                { code: "110011", name: "æ˜“æ–¹è¾¾ä¸­å°ç›˜", price: 5.23, change: 0.05, changePercent: 0.96, info: "æ˜“æ–¹è¾¾ä¸­å°ç›˜æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘ä¸»è¦æŠ•èµ„äºå…·æœ‰ç«äº‰ä¼˜åŠ¿å’Œè¾ƒé«˜æˆé•¿æ€§çš„ä¸­å°ç›˜è‚¡ç¥¨ã€‚" },
                { code: "000311", name: "æ™¯é¡ºé•¿åŸæ²ªæ·±300", price: 1.85, change: -0.02, changePercent: -1.07, info: "æ™¯é¡ºé•¿åŸæ²ªæ·±300æŒ‡æ•°å¢å¼ºå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘é‡‡ç”¨æŒ‡æ•°å¢å¼ºæŠ•èµ„ç­–ç•¥ï¼Œä»¥æ²ªæ·±300æŒ‡æ•°ä¸ºåŸºå‡†ã€‚" },
                { code: "001875", name: "å‰æµ·å¼€æºæ²ªæ¸¯æ·±", price: 2.67, change: 0.03, changePercent: 1.14, info: "å‰æµ·å¼€æºæ²ªæ¸¯æ·±ä¼˜åŠ¿ç²¾é€‰çµæ´»é…ç½®æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘å¯åŒæ—¶æŠ•èµ„äºæ²ªæ¸¯æ·±ä¸‰åœ°å¸‚åœºã€‚" },
                { code: "005827", name: "æ˜“æ–¹è¾¾è“ç­¹ç²¾é€‰", price: 2.15, change: 0.01, changePercent: 0.47, info: "æ˜“æ–¹è¾¾è“ç­¹ç²¾é€‰æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘ä¸»è¦æŠ•èµ„äºå…·æœ‰è¡Œä¸šåœ°ä½å’Œç«äº‰ä¼˜åŠ¿çš„è“ç­¹ä¼ä¸šã€‚" },
                { code: "161005", name: "å¯Œå›½å¤©æƒ æˆé•¿", price: 3.42, change: -0.04, changePercent: -1.16, info: "å¯Œå›½å¤©æƒ ç²¾é€‰æˆé•¿æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘ä¸»è¦æŠ•èµ„äºå…·æœ‰è‰¯å¥½æˆé•¿æ€§ä¸”åˆç†å®šä»·çš„è‚¡ç¥¨ã€‚" }
            ],
            futures: [
                { code: "IF2109", name: "æ²ªæ·±2109", price: 4852.6, change: 12.4, changePercent: 0.26, info: "æ²ªæ·±300æŒ‡æ•°æœŸè´§2109åˆçº¦ï¼Œä»¥æ²ªæ·±300æŒ‡æ•°ä¸ºæ ‡çš„çš„é‡‘èæœŸè´§åˆçº¦ã€‚" },
                { code: "IC2109", name: "ä¸­è¯2109", price: 6821.0, change: -23.6, changePercent: -0.34, info: "ä¸­è¯500æŒ‡æ•°æœŸè´§2109åˆçº¦ï¼Œä»¥ä¸­è¯500æŒ‡æ•°ä¸ºæ ‡çš„çš„é‡‘èæœŸè´§åˆçº¦ã€‚" },
                { code: "IH2109", name: "ä¸Šè¯2109", price: 3205.8, change: 5.2, changePercent: 0.16, info: "ä¸Šè¯50æŒ‡æ•°æœŸè´§2109åˆçº¦ï¼Œä»¥ä¸Šè¯50æŒ‡æ•°ä¸ºæ ‡çš„çš„é‡‘èæœŸè´§åˆçº¦ã€‚" },
                { code: "CU2110", name: "æ²ªé“œ2110", price: 68790, change: 320, changePercent: 0.47, info: "ä¸Šæµ·æœŸè´§äº¤æ˜“æ‰€é“œæœŸè´§2110åˆçº¦ï¼Œä»¥é“œä¸ºæ ‡çš„çš„å•†å“æœŸè´§åˆçº¦ã€‚" },
                { code: "AU2112", name: "æ²ªé‡‘2112", price: 376.32, change: -1.28, changePercent: -0.34, info: "ä¸Šæµ·æœŸè´§äº¤æ˜“æ‰€é»„é‡‘æœŸè´§2112åˆçº¦ï¼Œä»¥é»„é‡‘ä¸ºæ ‡çš„çš„å•†å“æœŸè´§åˆçº¦ã€‚" }
            ],
            bonds: [
                { code: "019547", name: "20å›½å€º07", price: 101.35, change: 0.05, changePercent: 0.05, info: "2020å¹´è®°è´¦å¼é™„æ¯(ä¸ƒæœŸ)å›½å€ºï¼Œç¥¨é¢åˆ©ç‡2.68%ï¼ŒæœŸé™10å¹´ã€‚" },
                { code: "019641", name: "21å›½å€º01", price: 100.82, change: -0.03, changePercent: -0.03, info: "2021å¹´è®°è´¦å¼é™„æ¯(ä¸€æœŸ)å›½å€ºï¼Œç¥¨é¢åˆ©ç‡2.85%ï¼ŒæœŸé™5å¹´ã€‚" },
                { code: "019627", name: "20å›½å€º12", price: 102.17, change: 0.08, changePercent: 0.08, info: "2020å¹´è®°è´¦å¼é™„æ¯(åäºŒæœŸ)å›½å€ºï¼Œç¥¨é¢åˆ©ç‡3.14%ï¼ŒæœŸé™30å¹´ã€‚" },
                { code: "019628", name: "20å›½å€º13", price: 101.95, change: 0.02, changePercent: 0.02, info: "2020å¹´è®°è´¦å¼é™„æ¯(åä¸‰æœŸ)å›½å€ºï¼Œç¥¨é¢åˆ©ç‡3.05%ï¼ŒæœŸé™20å¹´ã€‚" },
                { code: "019640", name: "21å›½å€º00", price: 100.50, change: 0.10, changePercent: 0.10, info: "2021å¹´è®°è´¦å¼é™„æ¯(æµ‹è¯•)å›½å€ºï¼Œç¥¨é¢åˆ©ç‡3.00%ï¼ŒæœŸé™10å¹´ã€‚" }
            ],
            currency: [
                { code: "USDCNY", name: "ç¾å…ƒ/äººæ°‘å¸", price: 6.4652, change: -0.0023, changePercent: -0.04, info: "ç¾å…ƒå…‘äººæ°‘å¸æ±‡ç‡ï¼Œåæ˜ ç¾å…ƒä¸äººæ°‘å¸ä¹‹é—´çš„å…‘æ¢æ¯”ç‡ã€‚" },
                { code: "EURCNY", name: "æ¬§å…ƒ/äººæ°‘å¸", price: 7.6325, change: 0.0125, changePercent: 0.16, info: "æ¬§å…ƒå…‘äººæ°‘å¸æ±‡ç‡ï¼Œåæ˜ æ¬§å…ƒä¸äººæ°‘å¸ä¹‹é—´çš„å…‘æ¢æ¯”ç‡ã€‚" },
                { code: "GBPCNY", name: "è‹±é•‘/äººæ°‘å¸", price: 8.8921, change: -0.0231, changePercent: -0.26, info: "è‹±é•‘å…‘äººæ°‘å¸æ±‡ç‡ï¼Œåæ˜ è‹±é•‘ä¸äººæ°‘å¸ä¹‹é—´çš„å…‘æ¢æ¯”ç‡ã€‚" },
                { code: "JPYCNY", name: "æ—¥å…ƒ/äººæ°‘å¸", price: 0.0589, change: 0.0001, changePercent: 0.17, info: "æ—¥å…ƒå…‘äººæ°‘å¸æ±‡ç‡ï¼Œåæ˜ æ—¥å…ƒä¸äººæ°‘å¸ä¹‹é—´çš„å…‘æ¢æ¯”ç‡ã€‚" },
                { code: "HKDCNY", name: "æ¸¯å¸/äººæ°‘å¸", price: 0.8312, change: -0.0005, changePercent: -0.06, info: "æ¸¯å¸å…‘äººæ°‘å¸æ±‡ç‡ï¼Œåæ˜ æ¸¯å¸ä¸äººæ°‘å¸ä¹‹é—´çš„å…‘æ¢æ¯”ç‡ã€‚" },
                { code: "BTCUSD", name: "æ¯”ç‰¹å¸/ç¾å…ƒ", price: 45032.50, change: 1250.75, changePercent: 2.86, info: "æ¯”ç‰¹å¸å…‘ç¾å…ƒæ±‡ç‡ï¼Œåæ˜ æ¯”ç‰¹å¸ä¸ç¾å…ƒä¹‹é—´çš„å…‘æ¢æ¯”ç‡ã€‚" }
            ],
            tasks: [
                { id: 1, name: "é¦–æ¬¡ç™»å½•", description: "é¦–æ¬¡ç™»å½•åº”ç”¨", reward: 1000, completed: false },
                { id: 2, name: "å®Œæˆç¬¬ä¸€ç¬”äº¤æ˜“", description: "å®Œæˆä»»æ„ä¸€ç¬”ä¹°å…¥æˆ–å–å‡ºäº¤æ˜“", reward: 2000, completed: false },
                { id: 3, name: "æŒæœ‰3ç§èµ„äº§", description: "åŒæ—¶æŒæœ‰3ç§ä¸åŒç±»å‹çš„èµ„äº§", reward: 3000, completed: false },
                { id: 4, name: "æ—¥ç›ˆåˆ©5%", description: "å•æ—¥ç›ˆåˆ©è¾¾åˆ°æ€»èµ„äº§çš„5%", reward: 5000, completed: false },
                { id: 5, name: "å‘¨ç›ˆåˆ©10%", description: "å•å‘¨ç›ˆåˆ©è¾¾åˆ°æ€»èµ„äº§çš„10%", reward: 10000, completed: false },
                { id: 6, name: "å®Œæˆ5ç¬”äº¤æ˜“", description: "ç´¯è®¡å®Œæˆ5ç¬”ä¹°å…¥æˆ–å–å‡ºäº¤æ˜“", reward: 5000, completed: false },
                { id: 7, name: "ä¹°æ¶¨ç›ˆåˆ©", description: "é€šè¿‡ä¹°æ¶¨è·å¾—ç›ˆåˆ©", reward: 3000, completed: false },
                { id: 8, name: "ä¹°è·Œç›ˆåˆ©", description: "é€šè¿‡ä¹°è·Œè·å¾—ç›ˆåˆ©", reward: 3000, completed: false },
                { id: 9, name: "æ€»ç›ˆåˆ©1ä¸‡å…ƒ", description: "ç´¯è®¡ç›ˆåˆ©è¾¾åˆ°1ä¸‡å…ƒ", reward: 10000, completed: false },
                { id: 10, name: "æŠ•èµ„æ‰€æœ‰å¸‚åœº", description: "åœ¨æ‰€æœ‰å¸‚åœºç±»å‹ä¸­éƒ½æœ‰æŠ•èµ„", reward: 8000, completed: false }
            ],
            milestones: [
                { id: 1, name: "åˆçº§æŠ•èµ„è€…", description: "æ€»èµ„äº§è¾¾åˆ°5ä¸‡å…ƒ", reward: 10000, target: 50000, progress: 0, completed: false },
                { id: 2, name: "ä¸­çº§æŠ•èµ„è€…", description: "æ€»èµ„äº§è¾¾åˆ°10ä¸‡å…ƒ", reward: 20000, target: 100000, progress: 0, completed: false },
                { id: 3, name: "é«˜çº§æŠ•èµ„è€…", description: "æ€»èµ„äº§è¾¾åˆ°50ä¸‡å…ƒ", reward: 50000, target: 500000, progress: 0, completed: false },
                { id: 4, name: "èµ„æ·±æŠ•èµ„è€…", description: "æ€»èµ„äº§è¾¾åˆ°100ä¸‡å…ƒ", reward: 100000, target: 1000000, progress: 0, completed: false },
                { id: 5, name: "äº¤æ˜“è¾¾äºº", description: "å®Œæˆ100ç¬”äº¤æ˜“", reward: 20000, target: 100, progress: 0, completed: false },
                { id: 6, name: "ç›ˆåˆ©é«˜æ‰‹", description: "ç´¯è®¡ç›ˆåˆ©è¾¾åˆ°10ä¸‡å…ƒ", reward: 30000, target: 100000, progress: 0, completed: false }
            ]
        };
        
        // å½“å‰äº¤æ˜“ä¿¡æ¯
        let currentTrade = {
            type: "", // "buy" or "sell"
            direction: "long", // "long" or "short"
            market: "", // "stocks", "funds", etc.
            index: -1, // index in the market data array
            positionIndex: -1 // index in the positions array (for sell)
        };
        
        // å½“å‰æŸ¥çœ‹çš„è¯¦æƒ…é¡¹
        let currentDetailItem = null;
        
        // æ•°æ®åº“å¼•ç”¨
        let db;
        
        // DOMå…ƒç´ 
        const elements = {
            mainContainer: document.getElementById("main-container"),
            detailContainer: document.getElementById("detail-container"),
            totalAssets: document.getElementById("total-assets"),
            todayProfit: document.getElementById("today-profit"),
            stockList: document.getElementById("stock-list"),
            fundList: document.getElementById("fund-list"),
            futuresList: document.getElementById("futures-list"),
            bondList: document.getElementById("bond-list"),
            currencyList: document.getElementById("currency-list"),
            positionList: document.getElementById("position-list"),
            taskList: document.getElementById("task-list"),
            milestoneList: document.getElementById("milestone-list"),
            accountBalance: document.getElementById("account-balance"),
            accountDebt: document.getElementById("account-debt"),
            accountNetWorth: document.getElementById("account-net-worth"),
            totalTrades: document.getElementById("total-trades"),
            totalProfit: document.getElementById("total-profit"),
            btnLoan: document.getElementById("btn-loan"),
            btnRepay: document.getElementById("btn-repay"),
            navTabs: document.querySelectorAll(".nav-tab"),
            tabContents: document.querySelectorAll(".tab-content"),
            footerNavItems: document.querySelectorAll(".footer-nav-item"),
            tradeModal: document.getElementById("trade-modal"),
            tradeModalTitle: document.getElementById("trade-modal-title"),
            tradeName: document.getElementById("trade-name"),
            tradeCode: document.getElementById("trade-code"),
            tradePrice: document.getElementById("trade-price"),
            tradeAmount: document.getElementById("trade-amount"),
            tradeTotal: document.getElementById("trade-total"),
            tradeDirectionGroup: document.getElementById("trade-direction-group"),
            tradeCancel: document.getElementById("trade-cancel"),
            tradeConfirm: document.getElementById("trade-confirm"),
            loanModal: document.getElementById("loan-modal"),
            loanAmount: document.getElementById("loan-amount"),
            loanCancel: document.getElementById("loan-cancel"),
            loanConfirm: document.getElementById("loan-confirm"),
            repayModal: document.getElementById("repay-modal"),
            repayAmount: document.getElementById("repay-amount"),
            maxRepay: document.getElementById("max-repay"),
            currentLoan: document.getElementById("current-loan"),
            repayCancel: document.getElementById("repay-cancel"),
            repayConfirm: document.getElementById("repay-confirm"),
            rewardModal: document.getElementById("reward-modal"),
            rewardMessage: document.getElementById("reward-message"),
            rewardClose: document.getElementById("reward-close"),
            milestoneModal: document.getElementById("milestone-modal"),
            milestoneMessage: document.getElementById("milestone-message"),
            milestoneClose: document.getElementById("milestone-close"),
            resetModal: document.getElementById("reset-modal"),
            resetClose: document.getElementById("reset-close"),
            detailBack: document.getElementById("detail-back"),
            detailTitle: document.getElementById("detail-title"),
            detailCode: document.getElementById("detail-code"),
            detailPrice: document.getElementById("detail-price"),
            detailChange: document.getElementById("detail-change"),
            detailInfo: document.getElementById("detail-info"),
            detailBuyLong: document.getElementById("detail-buy-long"),
            detailBuyShort: document.getElementById("detail-buy-short"),
            detailSell: document.getElementById("detail-sell"),
            klineChart: document.getElementById("kline-chart"),
            chartOpen: document.getElementById("chart-open"),
            chartHigh: document.getElementById("chart-high"),
            chartLow: document.getElementById("chart-low"),
            chartClose: document.getElementById("chart-close"),
            chartUp: document.getElementById("chart-up"),
            chartDown: document.getElementById("chart-down"),
            periodButtons: document.querySelectorAll(".chart-period-btn")
        };
        
        // åˆå§‹åŒ–æ•°æ®åº“
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // åˆ›å»ºç”¨æˆ·æ•°æ®å­˜å‚¨
                    if (!db.objectStoreNames.contains(STORES.USER_DATA)) {
                        const userStore = db.createObjectStore(STORES.USER_DATA, { keyPath: 'id' });
                        userStore.createIndex('balance', 'balance', { unique: false });
                    }
                    
                    // åˆ›å»ºå¸‚åœºæ•°æ®å­˜å‚¨
                    if (!db.objectStoreNames.contains(STORES.MARKET_DATA)) {
                        const marketStore = db.createObjectStore(STORES.MARKET_DATA, { keyPath: 'market' });
                    }
                    
                    // åˆ›å»ºä»·æ ¼å†å²å­˜å‚¨
                    if (!db.objectStoreNames.contains(STORES.PRICE_HISTORY)) {
                        const historyStore = db.createObjectStore(STORES.PRICE_HISTORY, { keyPath: ['market', 'code', 'timestamp'] });
                        historyStore.createIndex('market_code', ['market', 'code'], { unique: false });
                    }
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ");
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰åˆå§‹æ•°æ®
                    checkInitialData().then(() => {
                        resolve();
                    }).catch(error => {
                        console.error("æ£€æŸ¥åˆå§‹æ•°æ®å¤±è´¥:", error);
                        reject(error);
                    });
                };
                
                request.onerror = (event) => {
                    console.error("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®
        function checkInitialData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.USER_DATA, STORES.MARKET_DATA], 'readwrite');
                
                // æ£€æŸ¥ç”¨æˆ·æ•°æ®
                const userStore = transaction.objectStore(STORES.USER_DATA);
                const userRequest = userStore.get(1);
                
                userRequest.onsuccess = () => {
                    if (!userRequest.result) {
                        // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œåˆå§‹åŒ–
                        const newUserRequest = userStore.put({ 
                            id: 1, 
                            ...defaultUserData 
                        });
                        
                        newUserRequest.onsuccess = () => {
                            console.log("ç”¨æˆ·æ•°æ®åˆå§‹åŒ–æˆåŠŸ");
                        };
                        
                        newUserRequest.onerror = (event) => {
                            console.error("ç”¨æˆ·æ•°æ®åˆå§‹åŒ–å¤±è´¥:", event.target.error);
                        };
                    }
                };
                
                // æ£€æŸ¥å¸‚åœºæ•°æ®
                const marketStore = transaction.objectStore(STORES.MARKET_DATA);
                
                Object.keys(defaultMarketData).forEach(market => {
                    const marketRequest = marketStore.get(market);
                    
                    marketRequest.onsuccess = () => {
                        if (!marketRequest.result) {
                            // æ²¡æœ‰å¸‚åœºæ•°æ®ï¼Œåˆå§‹åŒ–
                            const newMarketRequest = marketStore.put({
                                market: market,
                                data: defaultMarketData[market]
                            });
                            
                            newMarketRequest.onsuccess = () => {
                                console.log(`å¸‚åœºæ•°æ® ${market} åˆå§‹åŒ–æˆåŠŸ`);
                            };
                            
                            newMarketRequest.onerror = (event) => {
                                console.error(`å¸‚åœºæ•°æ® ${market} åˆå§‹åŒ–å¤±è´¥:`, event.target.error);
                            };
                        }
                    };
                });
                
                transaction.oncomplete = () => {
                    resolve();
                };
                
                transaction.onerror = (event) => {
                    console.error("äº‹åŠ¡é”™è¯¯:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // è·å–ç”¨æˆ·æ•°æ®
        function getUserData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.USER_DATA], 'readonly');
                const store = transaction.objectStore(STORES.USER_DATA);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    resolve(request.result || { ...defaultUserData });
                };
                
                request.onerror = (event) => {
                    console.error("è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // æ›´æ–°ç”¨æˆ·æ•°æ®
        function updateUserData(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.USER_DATA], 'readwrite');
                const store = transaction.objectStore(STORES.USER_DATA);
                
                // æ·»åŠ æœ€åæ›´æ–°æ—¶é—´
                data.lastUpdate = new Date().getTime();
                
                const request = store.put(data);
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error("æ›´æ–°ç”¨æˆ·æ•°æ®å¤±è´¥:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // è·å–å¸‚åœºæ•°æ®
        function getMarketData(market) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.MARKET_DATA], 'readonly');
                const store = transaction.objectStore(STORES.MARKET_DATA);
                const request = store.get(market);
                
                request.onsuccess = () => {
                    resolve(request.result ? request.result.data : []);
                };
                
                request.onerror = (event) => {
                    console.error(`è·å–å¸‚åœºæ•°æ® ${market} å¤±è´¥:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // æ›´æ–°å¸‚åœºæ•°æ®
        function updateMarketData(market, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.MARKET_DATA], 'readwrite');
                const store = transaction.objectStore(STORES.MARKET_DATA);
                
                const request = store.put({
                    market: market,
                    data: data
                });
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error(`æ›´æ–°å¸‚åœºæ•°æ® ${market} å¤±è´¥:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // è·å–ä»·æ ¼å†å²
        function getPriceHistory(market, code, period = '1d', limit = 30) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.PRICE_HISTORY], 'readonly');
                const store = transaction.objectStore(STORES.PRICE_HISTORY);
                const index = store.index('market_code');
                
                // è®¡ç®—æ—¶é—´èŒƒå›´
                const now = new Date();
                let fromTime;
                
                switch (period) {
                    case '1d':
                        fromTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - limit).getTime();
                        break;
                    case '1w':
                        fromTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - limit * 7).getTime();
                        break;
                    case '1m':
                        fromTime = new Date(now.getFullYear(), now.getMonth() - limit, now.getDate()).getTime();
                        break;
                    default:
                        fromTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - limit).getTime();
                }
                
                const range = IDBKeyRange.bound([market, code, fromTime], [market, code, now.getTime()]);
                const request = index.getAll(range);
                
                request.onsuccess = () => {
                    // æŒ‰æ—¶é—´æ’åº
                    const history = request.result.sort((a, b) => a.timestamp - b.timestamp);
                    resolve(history);
                };
                
                request.onerror = (event) => {
                    console.error(`è·å–ä»·æ ¼å†å² ${market}-${code} å¤±è´¥:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // è®°å½•ä»·æ ¼å†å²
        function recordPriceHistory(market, code, priceData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORES.PRICE_HISTORY], 'readwrite');
                const store = transaction.objectStore(STORES.PRICE_HISTORY);
                
                const now = new Date();
                const timestamp = now.getTime();
                
                // ç”ŸæˆKçº¿æ•°æ®
                const klineData = {
                    market: market,
                    code: code,
                    timestamp: timestamp,
                    open: priceData.open || priceData.price,
                    high: priceData.high || priceData.price,
                    low: priceData.low || priceData.price,
                    close: priceData.price,
                    volume: priceData.volume || Math.floor(Math.random() * 10000) + 1000
                };
                
                const request = store.put(klineData);
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error(`è®°å½•ä»·æ ¼å†å² ${market}-${code} å¤±è´¥:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initDB().then(() => {
                return Promise.all([
                    getUserData(),
                    getMarketData('stocks'),
                    getMarketData('funds'),
                    getMarketData('futures'),
                    getMarketData('bonds'),
                    getMarketData('currency'),
                    getMarketData('tasks'),
                    getMarketData('milestones')
                ]);
            }).then(([userData, stocks, funds, futures, bonds, currency, tasks, milestones]) => {
                // åˆå§‹åŒ–æ•°æ®
                window.userData = userData;
                window.marketData = {
                    stocks: stocks,
                    funds: funds,
                    futures: futures,
                    bonds: bonds,
                    currency: currency,
                    tasks: tasks,
                    milestones: milestones
                };
                
                // æ¸²æŸ“ç•Œé¢
                renderMarketData();
                renderPositions();
                renderTasks();
                renderMilestones();
                updateAccountInfo();
                bindEvents();
                
                // æ£€æŸ¥é¦–æ¬¡ç™»å½•ä»»åŠ¡
                checkFirstLoginTask();
                
                // å¼€å§‹ä»·æ ¼æ³¢åŠ¨æ¨¡æ‹Ÿ
                setInterval(simulatePriceChanges, 5000);
            }).catch(error => {
                console.error("åº”ç”¨åˆå§‹åŒ–å¤±è´¥:", error);
                alert("åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            });
        }
        
        // æ¸²æŸ“å¸‚åœºæ•°æ®
        function renderMarketData() {
            renderStockList();
            renderFundList();
            renderFuturesList();
            renderBondList();
            renderCurrencyList();
        }
        
        function renderStockList() {
            elements.stockList.innerHTML = "";
            marketData.stocks.forEach((stock, index) => {
                const changeClass = stock.change >= 0 ? "profit-up" : "profit-down";
                const changeSign = stock.change >= 0 ? "+" : "";
                
                const stockItem = document.createElement("div");
                stockItem.className = "stock-item";
                stockItem.innerHTML = `
                    <div class="stock-info" data-market="stocks" data-index="${index}" style="flex: 2;">
                        <div class="stock-name">${stock.name}</div>
                        <div class="stock-code">${stock.code}</div>
                    </div>
                    <div class="stock-price">${stock.price.toFixed(2)}</div>
                    <div class="stock-change ${changeClass}">${changeSign}${stock.change.toFixed(2)} (${changeSign}${stock.changePercent.toFixed(2)}%)</div>
                    <button class="btn btn-buy" data-market="stocks" data-index="${index}">ä¹°</button>
                `;
                elements.stockList.appendChild(stockItem);
            });
        }
        
        function renderFundList() {
            elements.fundList.innerHTML = "";
            marketData.funds.forEach((fund, index) => {
                const changeClass = fund.change >= 0 ? "profit-up" : "profit-down";
                const changeSign = fund.change >= 0 ? "+" : "";
                
                const fundItem = document.createElement("div");
                fundItem.className = "fund-item";
                fundItem.innerHTML = `
                    <div class="fund-info" data-market="funds" data-index="${index}" style="flex: 2;">
                        <div class="fund-name">${fund.name}</div>
                        <div class="fund-code">${fund.code}</div>
                    </div>
                    <div class="fund-price">${fund.price.toFixed(2)}</div>
                    <div class="fund-change ${changeClass}">${changeSign}${fund.change.toFixed(2)} (${changeSign}${fund.changePercent.toFixed(2)}%)</div>
                    <button class="btn btn-buy" data-market="funds" data-index="${index}">ä¹°</button>
                `;
                elements.fundList.appendChild(fundItem);
            });
        }
        
        function renderFuturesList() {
            elements.futuresList.innerHTML = "";
            marketData.futures.forEach((future, index) => {
                const changeClass = future.change >= 0 ? "profit-up" : "profit-down";
                const changeSign = future.change >= 0 ? "+" : "";
                
                const futuresItem = document.createElement("div");
                futuresItem.className = "futures-item";
                futuresItem.innerHTML = `
                    <div class="futures-info" data-market="futures" data-index="${index}" style="flex: 2;">
                        <div class="futures-name">${future.name}</div>
                        <div class="futures-code">${future.code}</div>
                    </div>
                    <div class="futures-price">${future.price.toFixed(future.price > 100 ? 1 : 2)}</div>
                    <div class="futures-change ${changeClass}">${changeSign}${future.change.toFixed(2)} (${changeSign}${future.changePercent.toFixed(2)}%)</div>
                    <button class="btn btn-buy" data-market="futures" data-index="${index}">ä¹°</button>
                `;
                elements.futuresList.appendChild(futuresItem);
            });
        }
        
        function renderBondList() {
            elements.bondList.innerHTML = "";
            marketData.bonds.forEach((bond, index) => {
                const changeClass = bond.change >= 0 ? "profit-up" : "profit-down";
                const changeSign = bond.change >= 0 ? "+" : "";
                
                const bondItem = document.createElement("div");
                bondItem.className = "bond-item";
                bondItem.innerHTML = `
                    <div class="bond-info" data-market="bonds" data-index="${index}" style="flex: 2;">
                        <div class="bond-name">${bond.name}</div>
                        <div class="bond-code">${bond.code}</div>
                    </div>
                    <div class="bond-price">${bond.price.toFixed(2)}</div>
                    <div class="bond-change ${changeClass}">${changeSign}${bond.change.toFixed(2)} (${changeSign}${bond.changePercent.toFixed(2)}%)</div>
                    <button class="btn btn-buy" data-market="bonds" data-index="${index}">ä¹°</button>
                `;
                elements.bondList.appendChild(bondItem);
            });
        }
        
        function renderCurrencyList() {
            elements.currencyList.innerHTML = "";
            marketData.currency.forEach((currency, index) => {
                const changeClass = currency.change >= 0 ? "profit-up" : "profit-down";
                const changeSign = currency.change >= 0 ? "+" : "";
                
                const currencyItem = document.createElement("div");
                currencyItem.className = "currency-item";
                currencyItem.innerHTML = `
                    <div class="currency-info" data-market="currency" data-index="${index}" style="flex: 2;">
                        <div class="currency-name">${currency.name}</div>
                        <div class="currency-code">${currency.code}</div>
                    </div>
                    <div class="currency-price">${currency.code === 'BTCUSD' ? currency.price.toFixed(2) : currency.price.toFixed(4)}</div>
                    <div class="currency-change ${changeClass}">${changeSign}${currency.code === 'BTCUSD' ? currency.change.toFixed(2) : currency.change.toFixed(4)} (${changeSign}${currency.changePercent.toFixed(2)}%)</div>
                    <button class="btn btn-buy" data-market="currency" data-index="${index}">ä¹°</button>
                `;
                elements.currencyList.appendChild(currencyItem);
            });
        }
        
        // æ¸²æŸ“æŒä»“åˆ—è¡¨
        function renderPositions() {
            elements.positionList.innerHTML = "";
            
            if (userData.positions.length === 0) {
                const emptyMsg = document.createElement("div");
                emptyMsg.className = "position-item";
                emptyMsg.textContent = "æš‚æ— æŒä»“";
                elements.positionList.appendChild(emptyMsg);
                return;
            }
            
            userData.positions.forEach((position, index) => {
                const currentPrice = getCurrentPrice(position.market, position.code);
                let profit = 0;
                
                if (position.direction === 'short') {
                    // ä¹°è·Œçš„ç›ˆåˆ©è®¡ç®—æ–¹å¼ä¸åŒ
                    profit = (position.price - currentPrice) * position.amount;
                } else {
                    // ä¹°æ¶¨çš„ç›ˆåˆ©è®¡ç®—
                    profit = (currentPrice - position.price) * position.amount;
                }
                
                const profitPercent = (profit / (position.price * position.amount)) * 100;
                const profitClass = profit >= 0 ? "profit-up" : "profit-down";
                const profitSign = profit >= 0 ? "+" : "";
                
                const positionItem = document.createElement("div");
                positionItem.className = "position-item";
                positionItem.innerHTML = `
                    <div class="position-header">
                        <div class="position-name" data-market="${position.market}" data-code="${position.code}" style="cursor: pointer;">${position.name} ${position.direction === 'short' ? '(ä¹°è·Œ)' : ''}</div>
                        <div class="position-code">${position.code}</div>
                    </div>
                    <div class="position-details">
                        <div>æŒä»“: ${position.amount}</div>
                        <div>æˆæœ¬: ${position.price.toFixed(2)}</div>
                        <div>ç°ä»·: ${currentPrice.toFixed(2)}</div>
                    </div>
                    <div class="position-details">
                        <div>æ–¹å‘: ${position.direction === 'short' ? 'ä¹°è·Œ' : 'ä¹°æ¶¨'}</div>
                        <div>ç›ˆäº: <span class="${profitClass}">${profitSign}${profit.toFixed(2)} (${profitSign}${profitPercent.toFixed(2)}%)</span></div>
                    </div>
                    <div class="position-details">
                        <div>å¸‚å€¼: ${(currentPrice * position.amount).toFixed(2)}</div>
                    </div>
                    <div class="position-actions">
                        <button class="btn btn-buy" data-action="buy-more" data-market="${position.market}" data-code="${position.code}">åŠ ä»“</button>
                        <button class="btn btn-sell" data-action="sell" data-index="${index}">å–å‡º</button>
                    </div>
                `;
                elements.positionList.appendChild(positionItem);
            });
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            elements.taskList.innerHTML = "";
            
            marketData.tasks.forEach(task => {
                const taskItem = document.createElement("div");
                taskItem.className = "task-item";
                
                const completed = userData.completedTasks.includes(task.id);
                const btnClass = completed ? "btn" : "btn btn-buy";
                const btnText = completed ? "å·²å®Œæˆ" : "é¢†å–";
                const btnDisabled = completed ? "disabled" : "";
                
                taskItem.innerHTML = `
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-desc">${task.description}</div>
                    </div>
                    <div class="task-reward">+Â¥${task.reward}</div>
                    <button class="${btnClass}" data-task-id="${task.id}" ${btnDisabled}>${btnText}</button>
                `;
                elements.taskList.appendChild(taskItem);
            });
        }
        
        // æ¸²æŸ“é‡Œç¨‹ç¢‘åˆ—è¡¨
        function renderMilestones() {
            elements.milestoneList.innerHTML = "";
            
            marketData.milestones.forEach(milestone => {
                const completed = userData.completedMilestones.includes(milestone.id);
                const btnClass = completed ? "btn" : "btn btn-buy";
                const btnText = completed ? "å·²å®Œæˆ" : "";
                const btnDisabled = completed ? "disabled" : "";
                
                // è®¡ç®—è¿›åº¦
                let progress = 0;
                if (milestone.id <= 4) {
                    // èµ„äº§é‡Œç¨‹ç¢‘
                    let totalValue = userData.balance;
                    userData.positions.forEach(position => {
                        const currentPrice = getCurrentPrice(position.market, position.code);
                        totalValue += currentPrice * position.amount;
                    });
                    progress = Math.min(100, (totalValue / milestone.target) * 100);
                } else if (milestone.id === 5) {
                    // äº¤æ˜“æ¬¡æ•°é‡Œç¨‹ç¢‘
                    progress = Math.min(100, (userData.totalTrades / milestone.target) * 100);
                } else if (milestone.id === 6) {
                    // ç›ˆåˆ©é‡Œç¨‹ç¢‘
                    progress = Math.min(100, (userData.totalProfit / milestone.target) * 100);
                }
                
                const milestoneItem = document.createElement("div");
                milestoneItem.className = "milestone-item";
                milestoneItem.innerHTML = `
                    <div class="milestone-info">
                        <div class="milestone-name">${milestone.name}</div>
                        <div class="milestone-desc">${milestone.description}</div>
                        <div class="milestone-progress">
                            <div class="milestone-progress-bar" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <div class="milestone-reward">+Â¥${milestone.reward}</div>
                    <button class="${btnClass}" data-milestone-id="${milestone.id}" ${btnDisabled}>${btnText}</button>
                `;
                elements.milestoneList.appendChild(milestoneItem);
            });
        }
        
        // æ›´æ–°è´¦æˆ·ä¿¡æ¯
        function updateAccountInfo() {
            // è®¡ç®—æ€»èµ„äº§
            let totalValue = userData.balance;
            userData.positions.forEach(position => {
                const currentPrice = getCurrentPrice(position.market, position.code);
                totalValue += currentPrice * position.amount;
            });
            
            // æ£€æŸ¥è´Ÿå€ºæ˜¯å¦è¶…è¿‡1äº¿ï¼Œå¦‚æœæ˜¯åˆ™é‡ç½®
            if (totalValue < -100000000) {
                resetAccount();
                return;
            }
            
            // æ›´æ–°æ€»èµ„äº§æ˜¾ç¤º
            elements.totalAssets.textContent = `Â¥${totalValue.toFixed(2)}`;
            
            // æ›´æ–°ä»Šæ—¥ç›ˆäºæ˜¾ç¤º
            const profitSign = userData.todayProfit >= 0 ? "+" : "";
            const profitClass = userData.todayProfit >= 0 ? "profit-up" : "profit-down";
            elements.todayProfit.textContent = `${profitSign}Â¥${Math.abs(userData.todayProfit).toFixed(2)} (${profitSign}${(userData.todayProfit / (totalValue - userData.todayProfit) * 100).toFixed(2)}%)`;
            elements.todayProfit.className = `account-profit ${profitClass}`;
            
            // æ›´æ–°è´¦æˆ·é¡µä¿¡æ¯
            elements.accountBalance.textContent = `Â¥${userData.balance.toFixed(2)}`;
            elements.accountDebt.textContent = `Â¥${userData.debt.toFixed(2)}`;
            elements.accountNetWorth.textContent = `Â¥${(userData.balance - userData.debt).toFixed(2)}`;
            elements.totalTrades.textContent = userData.totalTrades;
            elements.totalProfit.textContent = `Â¥${userData.totalProfit.toFixed(2)}`;
            
            // æ£€æŸ¥é‡Œç¨‹ç¢‘
            checkMilestones();
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            updateUserData(userData).catch(error => {
                console.error("ä¿å­˜ç”¨æˆ·æ•°æ®å¤±è´¥:", error);
            });
        }
        
        // é‡ç½®è´¦æˆ·
        function resetAccount() {
            // é‡ç½®ç”¨æˆ·æ•°æ®
            userData = {
                ...defaultUserData,
                // ä¿ç•™å·²å®Œæˆçš„ä»»åŠ¡å’Œé‡Œç¨‹ç¢‘
                completedTasks: [...userData.completedTasks],
                completedMilestones: [...userData.completedMilestones]
            };
            
            // æ›´æ–°ç•Œé¢
            updateAccountInfo();
            renderPositions();
            renderTasks();
            renderMilestones();
            
            // æ˜¾ç¤ºé‡ç½®æç¤º
            elements.resetModal.style.display = "flex";
        }
        
        // è·å–å½“å‰ä»·æ ¼
        function getCurrentPrice(market, code) {
            const items = marketData[market];
            if (!items) return 0;
            
            const item = items.find(item => item.code === code);
            return item ? item.price : 0;
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // å¯¼èˆªæ ‡ç­¾åˆ‡æ¢
            elements.navTabs.forEach(tab => {
                tab.addEventListener("click", () => {
                    elements.navTabs.forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");
                    
                    const tabId = `${tab.dataset.tab}-tab`;
                    elements.tabContents.forEach(content => content.classList.remove("active"));
                    document.getElementById(tabId).classList.add("active");
                });
            });
            
            // åº•éƒ¨å¯¼èˆªåˆ‡æ¢
            elements.footerNavItems.forEach(item => {
                item.addEventListener("click", () => {
                    if (item.classList.contains("active")) return;
                    
                    elements.footerNavItems.forEach(i => i.classList.remove("active"));
                    item.classList.add("active");
                    
                    const tabId = item.dataset.tab;
                    if (tabId === "market") {
                        // æ˜¾ç¤ºè¡Œæƒ…æ ‡ç­¾
                        elements.tabContents.forEach(content => content.classList.remove("active"));
                        document.getElementById("stocks-tab").classList.add("active");
                        elements.navTabs.forEach(t => t.classList.remove("active"));
                        elements.navTabs[0].classList.add("active");
                    } else if (tabId === "positions") {
                        // æ˜¾ç¤ºæŒä»“
                        elements.tabContents.forEach(content => content.classList.remove("active"));
                        document.getElementById("positions-tab").classList.add("active");
                    } else if (tabId === "tasks") {
                        // æ˜¾ç¤ºä»»åŠ¡
                        elements.tabContents.forEach(content => content.classList.remove("active"));
                        document.getElementById("tasks-tab").classList.add("active");
                    } else if (tabId === "milestones") {
                        // æ˜¾ç¤ºé‡Œç¨‹ç¢‘
                        elements.tabContents.forEach(content => content.classList.remove("active"));
                        document.getElementById("milestones-tab").classList.add("active");
                    } else if (tabId === "account") {
                        // æ˜¾ç¤ºè´¦æˆ·
                        elements.tabContents.forEach(content => content.classList.remove("active"));
                        document.getElementById("account-tab").classList.add("active");
                    }
                });
            });
            
            // ä¹°å…¥æŒ‰é’®
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-buy") && !e.target.dataset.action) {
                    const market = e.target.dataset.market;
                    const index = parseInt(e.target.dataset.index);
                    
                    openTradeModal("buy", market, index);
                }
            });
            
            // åŠ ä»“æŒ‰é’®
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-buy") && e.target.dataset.action === "buy-more") {
                    const market = e.target.dataset.market;
                    const code = e.target.dataset.code;
                    
                    // æ‰¾åˆ°å¯¹åº”çš„å¸‚åœºæ•°æ®ç´¢å¼•
                    const items = marketData[market];
                    const index = items.findIndex(item => item.code === code);
                    
                    if (index !== -1) {
                        openTradeModal("buy", market, index);
                    }
                }
            });
            
            // å–å‡ºæŒ‰é’®
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-sell")) {
                    const positionIndex = parseInt(e.target.dataset.index);
                    const position = userData.positions[positionIndex];
                    
                    // æ‰¾åˆ°å¯¹åº”çš„å¸‚åœºæ•°æ®ç´¢å¼•
                    const items = marketData[position.market];
                    const marketIndex = items.findIndex(item => item.code === position.code);
                    
                    if (marketIndex !== -1) {
                        openTradeModal("sell", position.market, marketIndex, positionIndex);
                    }
                }
            });
            
            // äº¤æ˜“æ•°é‡å˜åŒ–
            elements.tradeAmount.addEventListener("input", () => {
                updateTradeTotal();
            });
            
            // å–æ¶ˆäº¤æ˜“
            elements.tradeCancel.addEventListener("click", () => {
                closeTradeModal();
            });
            
            // ç¡®è®¤äº¤æ˜“
            elements.tradeConfirm.addEventListener("click", () => {
                executeTrade();
            });
            
            // é¢†å–ä»»åŠ¡å¥–åŠ±
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-buy") && e.target.dataset.taskId) {
                    const taskId = parseInt(e.target.dataset.taskId);
                    claimTaskReward(taskId);
                }
            });
            
            // é¢†å–é‡Œç¨‹ç¢‘å¥–åŠ±
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("btn-buy") && e.target.dataset.milestoneId) {
                    const milestoneId = parseInt(e.target.dataset.milestoneId);
                    claimMilestoneReward(milestoneId);
                }
            });
            
            // å…³é—­å¥–åŠ±å¼¹çª—
            elements.rewardClose.addEventListener("click", () => {
                elements.rewardModal.style.display = "none";
            });
            
            // å…³é—­é‡Œç¨‹ç¢‘å¼¹çª—
            elements.milestoneClose.addEventListener("click", () => {
                elements.milestoneModal.style.display = "none";
            });
            
            // å…³é—­é‡ç½®å¼¹çª—
            elements.resetClose.addEventListener("click", () => {
                elements.resetModal.style.display = "none";
            });
            
            // è¿”å›æŒ‰é’®
            elements.detailBack.addEventListener("click", () => {
                showMainView();
            });
            
            // è¯¦æƒ…é¡µä¹°æ¶¨æŒ‰é’®
            elements.detailBuyLong.addEventListener("click", () => {
                if (currentDetailItem) {
                    const market = currentDetailItem.market;
                    const items = marketData[market];
                    const index = items.findIndex(item => item.code === currentDetailItem.code);
                    
                    if (index !== -1) {
                        openTradeModal("buy", market, index);
                    }
                }
            });
            
            // è¯¦æƒ…é¡µä¹°è·ŒæŒ‰é’®
            elements.detailBuyShort.addEventListener("click", () => {
                if (currentDetailItem) {
                    const market = currentDetailItem.market;
                    const items = marketData[market];
                    const index = items.findIndex(item => item.code === currentDetailItem.code);
                    
                    if (index !== -1) {
                        openTradeModal("buy", market, index);
                        // è®¾ç½®æ–¹å‘ä¸ºä¹°è·Œ
                        document.getElementById("trade-direction-short").checked = true;
                    }
                }
            });
            
            // è¯¦æƒ…é¡µå–å‡ºæŒ‰é’®
            elements.detailSell.addEventListener("click", () => {
                if (currentDetailItem) {
                    const positionIndex = userData.positions.findIndex(
                        p => p.market === currentDetailItem.market && p.code === currentDetailItem.code
                    );
                    
                    if (positionIndex !== -1) {
                        const market = currentDetailItem.market;
                        const items = marketData[market];
                        const marketIndex = items.findIndex(item => item.code === currentDetailItem.code);
                        
                        if (marketIndex !== -1) {
                            openTradeModal("sell", market, marketIndex, positionIndex);
                        }
                    } else {
                        alert("æ‚¨æ²¡æœ‰è¯¥èµ„äº§çš„æŒä»“");
                    }
                }
            });
            
            // Kçº¿å›¾å‘¨æœŸåˆ‡æ¢
            elements.periodButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    elements.periodButtons.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    
                    if (currentDetailItem) {
                        renderKlineChart(currentDetailItem.market, currentDetailItem.code, btn.dataset.period);
                    }
                });
            });
            
            // ç‚¹å‡»é¡¹ç›®åç§°è¿›å…¥è¯¦æƒ…é¡µ
            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("stock-name") || 
                    e.target.classList.contains("fund-name") || 
                    e.target.classList.contains("futures-name") || 
                    e.target.classList.contains("bond-name") || 
                    e.target.classList.contains("currency-name") ||
                    e.target.classList.contains("position-name")) {
                    
                    let market, code;
                    
                    if (e.target.classList.contains("position-name")) {
                        market = e.target.dataset.market;
                        code = e.target.dataset.code;
                    } else {
                        const infoElement = e.target.closest(".stock-info, .fund-info, .futures-info, .bond-info, .currency-info");
                        if (infoElement) {
                            market = infoElement.dataset.market;
                            const index = parseInt(infoElement.dataset.index);
                            code = marketData[market][index].code;
                        }
                    }
                    
                    if (market && code) {
                        showDetailView(market, code);
                    }
                }
            });
            
            // è´·æ¬¾æŒ‰é’®
            elements.btnLoan.addEventListener("click", () => {
                openLoanModal();
            });
            
            // è¿˜æ¬¾æŒ‰é’®
            elements.btnRepay.addEventListener("click", () => {
                openRepayModal();
            });
            
            // è´·æ¬¾é‡‘é¢å˜åŒ–
            elements.loanAmount.addEventListener("input", () => {
                const amount = parseInt(elements.loanAmount.value) || 0;
                if (amount < 1) {
                    elements.loanAmount.value = "1";
                }
            });
            
            // è¿˜æ¬¾é‡‘é¢å˜åŒ–
            elements.repayAmount.addEventListener("input", () => {
                const amount = parseInt(elements.repayAmount.value) || 0;
                const maxRepay = parseInt(elements.maxRepay.textContent);
                
                if (amount < 1) {
                    elements.repayAmount.value = "1";
                } else if (amount > maxRepay) {
                    elements.repayAmount.value = maxRepay;
                }
            });
            
            // å–æ¶ˆè´·æ¬¾
            elements.loanCancel.addEventListener("click", () => {
                elements.loanModal.style.display = "none";
            });
            
            // ç¡®è®¤è´·æ¬¾
            elements.loanConfirm.addEventListener("click", () => {
                const amount = parseInt(elements.loanAmount.value) || 0;
                if (amount > 0) {
                    userData.balance += amount;
                    userData.debt += amount;
                    updateAccountInfo();
                    elements.loanModal.style.display = "none";
                }
            });
            
            // å–æ¶ˆè¿˜æ¬¾
            elements.repayCancel.addEventListener("click", () => {
                elements.repayModal.style.display = "none";
            });
            
            // ç¡®è®¤è¿˜æ¬¾
            elements.repayConfirm.addEventListener("click", () => {
                const amount = parseInt(elements.repayAmount.value) || 0;
                const maxRepay = Math.min(userData.balance, userData.debt);
                
                if (amount > 0 && amount <= maxRepay) {
                    userData.balance -= amount;
                    userData.debt -= amount;
                    updateAccountInfo();
                    elements.repayModal.style.display = "none";
                }
            });
        }
        
        // æ‰“å¼€è´·æ¬¾æ¨¡æ€æ¡†
        function openLoanModal() {
            elements.loanAmount.value = "1000";
            elements.loanModal.style.display = "flex";
        }
        
        // æ‰“å¼€è¿˜æ¬¾æ¨¡æ€æ¡†
        function openRepayModal() {
            const maxRepay = Math.min(userData.balance, userData.debt);
            elements.maxRepay.textContent = maxRepay;
            elements.currentLoan.textContent = `Â¥${userData.debt.toFixed(2)}`;
            elements.repayAmount.value = maxRepay > 0 ? "1" : "0";
            elements.repayAmount.max = maxRepay;
            elements.repayModal.style.display = "flex";
        }
        
        // æ˜¾ç¤ºè¯¦æƒ…é¡µ
        function showDetailView(market, code) {
            const items = marketData[market];
            const item = items.find(item => item.code === code);
            
            if (!item) return;
            
            currentDetailItem = {
                market: market,
                code: code,
                name: item.name
            };
            
            // æ›´æ–°è¯¦æƒ…é¡µä¿¡æ¯
            elements.detailTitle.textContent = item.name;
            elements.detailCode.textContent = code;
            elements.detailPrice.textContent = item.price.toFixed(item.price > 100 ? 2 : 4);
            
            const changeClass = item.change >= 0 ? "profit-up" : "profit-down";
            const changeSign = item.change >= 0 ? "+" : "";
            elements.detailChange.textContent = `${changeSign}${item.change.toFixed(2)} (${changeSign}${item.changePercent.toFixed(2)}%)`;
            elements.detailChange.className = `detail-change ${changeClass}`;
            
            elements.detailInfo.textContent = item.info || "æš‚æ— è¯¦ç»†ä¿¡æ¯";
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æŒä»“
            const hasPosition = userData.positions.some(p => p.market === market && p.code === code);
            elements.detailSell.style.display = hasPosition ? "block" : "none";
            
            // æ¸²æŸ“Kçº¿å›¾
            renderKlineChart(market, code, '1d');
            
            // åˆ‡æ¢è§†å›¾
            elements.mainContainer.style.display = "none";
            elements.detailContainer.style.display = "block";
        }
        
        // æ˜¾ç¤ºä¸»è§†å›¾
        function showMainView() {
            elements.mainContainer.style.display = "block";
            elements.detailContainer.style.display = "none";
            currentDetailItem = null;
        }
        
        // æ¸²æŸ“Kçº¿å›¾
        function renderKlineChart(market, code, period = '1d') {
            getPriceHistory(market, code, period).then(history => {
                if (history.length === 0) {
                    // å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œç”Ÿæˆä¸€äº›æ¨¡æ‹Ÿæ•°æ®
                    const now = new Date();
                    const item = marketData[market].find(item => item.code === code);
                    const basePrice = item.price;
                    
                    history = [];
                    
                    for (let i = 30; i >= 0; i--) {
                        const date = new Date(now);
                        
                        if (period === '1d') {
                            date.setDate(date.getDate() - i);
                        } else if (period === '1w') {
                            date.setDate(date.getDate() - i * 7);
                        } else if (period === '1m') {
                            date.setMonth(date.getMonth() - i);
                        }
                        
                        const fluctuation = (Math.random() - 0.5) * 0.1;
                        const price = basePrice * (1 + fluctuation);
                        const open = price * (1 + (Math.random() - 0.5) * 0.02);
                        const close = price * (1 + (Math.random() - 0.5) * 0.02);
                        const high = Math.max(open, close) * (1 + Math.random() * 0.01);
                        const low = Math.min(open, close) * (1 - Math.random() * 0.01);
                        
                        history.push({
                            timestamp: date.getTime(),
                            open: open,
                            high: high,
                            low: low,
                            close: close,
                            volume: Math.floor(Math.random() * 10000) + 1000
                        });
                    }
                    
                    // ä¿å­˜æ¨¡æ‹Ÿæ•°æ®
                    const savePromises = history.map(item => {
                        return recordPriceHistory(market, code, {
                            price: item.close,
                            open: item.open,
                            high: item.high,
                            low: item.low,
                            volume: item.volume
                        });
                    });
                    
                    Promise.all(savePromises).catch(error => {
                        console.error("ä¿å­˜æ¨¡æ‹Ÿä»·æ ¼å†å²å¤±è´¥:", error);
                    });
                }
                
                // æ›´æ–°Kçº¿å›¾ä¿¡æ¯
                const latest = history[history.length - 1];
                elements.chartOpen.textContent = latest.open.toFixed(4);
                elements.chartHigh.textContent = latest.high.toFixed(4);
                elements.chartLow.textContent = latest.low.toFixed(4);
                elements.chartClose.textContent = latest.close.toFixed(4);
                
                // è®¡ç®—æ¶¨è·Œæ¬¡æ•°
                let upCount = 0;
                let downCount = 0;
                
                for (let i = 1; i < history.length; i++) {
                    if (history[i].close > history[i-1].close) {
                        upCount++;
                    } else if (history[i].close < history[i-1].close) {
                        downCount++;
                    }
                }
                
                elements.chartUp.textContent = upCount;
                elements.chartDown.textContent = downCount;
                
                // ç»˜åˆ¶Kçº¿å›¾
                drawKlineChart(history);
            }).catch(error => {
                console.error("è·å–ä»·æ ¼å†å²å¤±è´¥:", error);
            });
        }
        
        // ç»˜åˆ¶Kçº¿å›¾
        function drawKlineChart(data) {
            const canvas = elements.klineChart;
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¡ç®—ä»·æ ¼èŒƒå›´
            let minPrice = Infinity;
            let maxPrice = -Infinity;
            
            data.forEach(item => {
                minPrice = Math.min(minPrice, item.low);
                maxPrice = Math.max(maxPrice, item.high);
            });
            
            // æ·»åŠ ä¸€äº›è¾¹è·
            const priceRange = maxPrice - minPrice;
            minPrice -= priceRange * 0.1;
            maxPrice += priceRange * 0.1;
            
            // è®¡ç®—æ—¶é—´èŒƒå›´
            const minTime = data[0].timestamp;
            const maxTime = data[data.length - 1].timestamp;
            
            // ç»˜åˆ¶ç½‘æ ¼å’Œåæ ‡è½´
            const padding = { top: 20, right: 30, bottom: 30, left: 50 };
            const width = canvas.offsetWidth - padding.left - padding.right;
            const height = canvas.offsetHeight - padding.top - padding.bottom;
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            
            // æ°´å¹³ç½‘æ ¼çº¿
            const horizontalLines = 5;
            for (let i = 0; i <= horizontalLines; i++) {
                const y = padding.top + (height - (height / horizontalLines) * i);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + width, y);
                ctx.stroke();
                
                // ä»·æ ¼æ ‡ç­¾
                const price = minPrice + (maxPrice - minPrice) * (i / horizontalLines);
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(price.toFixed(2), padding.left - 5, y + 4);
            }
            
            // å‚ç›´ç½‘æ ¼çº¿
            const verticalLines = Math.min(10, data.length);
            const step = Math.floor(data.length / verticalLines);
            for (let i = 0; i < data.length; i += step) {
                const x = padding.left + (width * (i / (data.length - 1)));
                ctx.beginPath();
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, padding.top + height);
                ctx.stroke();
                
                // æ—¶é—´æ ‡ç­¾
                const date = new Date(data[i].timestamp);
                let timeStr;
                
                if (data.length <= 30) {
                    // æ—¥çº¿æ˜¾ç¤ºæ—¥æœŸ
                    timeStr = `${date.getMonth() + 1}/${date.getDate()}`;
                } else {
                    // å‘¨çº¿æˆ–æœˆçº¿æ˜¾ç¤ºæœˆä»½
                    timeStr = `${date.getFullYear()}/${date.getMonth() + 1}`;
                }
                
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(timeStr, x, padding.top + height + 15);
            }
            
            // ç»˜åˆ¶Kçº¿
            const candleWidth = (width / data.length) * 0.8;
            
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                const x = padding.left + (width * (i / (data.length - 1)));
                const yOpen = padding.top + height - ((item.open - minPrice) / (maxPrice - minPrice)) * height;
                const yClose = padding.top + height - ((item.close - minPrice) / (maxPrice - minPrice)) * height;
                const yHigh = padding.top + height - ((item.high - minPrice) / (maxPrice - minPrice)) * height;
                const yLow = padding.top + height - ((item.low - minPrice) / (maxPrice - minPrice)) * height;
                
                // åˆ¤æ–­æ¶¨è·Œ
                const isUp = item.close >= item.open;
                
                // ç»˜åˆ¶å½±çº¿
                ctx.strokeStyle = isUp ? '#f44336' : '#4CAF50';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, yHigh);
                ctx.lineTo(x, yLow);
                ctx.stroke();
                
                // ç»˜åˆ¶å®ä½“
                ctx.fillStyle = isUp ? '#f44336' : '#4CAF50';
                const candleHeight = Math.max(1, Math.abs(yOpen - yClose));
                const candleY = Math.min(yOpen, yClose);
                ctx.fillRect(x - candleWidth / 2, candleY, candleWidth, candleHeight);
                
                // ç§»é™¤äº†è¿æ¥Kçº¿çš„ç»†çº¿ä»£ç 
            }
        }
        
        // æ‰“å¼€äº¤æ˜“æ¨¡æ€æ¡†
        function openTradeModal(type, market, index, positionIndex = -1) {
            currentTrade.type = type;
            currentTrade.market = market;
            currentTrade.index = index;
            currentTrade.positionIndex = positionIndex;
            
            const item = marketData[market][index];
            
            elements.tradeModalTitle.textContent = type === "buy" ? `ä¹°å…¥${getMarketName(market)}` : `å–å‡º${getMarketName(market)}`;
            elements.tradeName.value = item.name;
            elements.tradeCode.value = item.code;
            elements.tradePrice.value = item.price.toFixed(2);
            elements.tradeAmount.value = type === "buy" ? "100" : userData.positions[positionIndex].amount.toString();
            elements.tradeConfirm.className = type === "buy" ? "btn btn-buy" : "btn btn-sell";
            elements.tradeConfirm.textContent = type === "buy" ? "ä¹°å…¥" : "å–å‡º";
            
            // å¦‚æœæ˜¯å–å‡ºæ“ä½œï¼Œéšè—æ–¹å‘é€‰æ‹©
            if (type === "sell") {
                elements.tradeDirectionGroup.style.display = "none";
            } else {
                elements.tradeDirectionGroup.style.display = "flex";
            }
            
            updateTradeTotal();
            elements.tradeModal.style.display = "flex";
        }
        
        // è·å–å¸‚åœºåç§°
        function getMarketName(market) {
            const names = {
                stocks: "è‚¡ç¥¨",
                funds: "åŸºé‡‘",
                futures: "æœŸè´§",
                bonds: "å›½å€º",
                currency: "è´§å¸"
            };
            return names[market] || "";
        }
        
        // æ›´æ–°äº¤æ˜“æ€»ä»·
        function updateTradeTotal() {
            const price = parseFloat(elements.tradePrice.value);
            const amount = parseInt(elements.tradeAmount.value) || 0;
            const total = price * amount;
            
            elements.tradeTotal.value = total.toFixed(2);
        }
        
        // å…³é—­äº¤æ˜“æ¨¡æ€æ¡†
        function closeTradeModal() {
            elements.tradeModal.style.display = "none";
        }
        
        // æ‰§è¡Œäº¤æ˜“
        function executeTrade() {
            const price = parseFloat(elements.tradePrice.value);
            const amount = parseInt(elements.tradeAmount.value);
            const total = price * amount;
            const item = marketData[currentTrade.market][currentTrade.index];
            const direction = document.getElementById("trade-direction-long").checked ? "long" : "short";
            
            if (currentTrade.type === "buy") {
                // ä¹°å…¥é€»è¾‘
                if (total > userData.balance + userData.debt) {
                    alert("èµ„é‡‘ä¸è¶³");
                    return;
                }
                
                userData.balance -= total;
                userData.totalTrades++;
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥æŒä»“
                const existingPositionIndex = userData.positions.findIndex(
                    p => p.market === currentTrade.market && p.code === item.code && p.direction === direction
                );
                
                if (existingPositionIndex !== -1) {
                    // å·²æœ‰æŒä»“ï¼Œæ›´æ–°æŒä»“
                    const position = userData.positions[existingPositionIndex];
                    const totalAmount = position.amount + amount;
                    const avgPrice = (position.price * position.amount + price * amount) / totalAmount;
                    
                    userData.positions[existingPositionIndex] = {
                        ...position,
                        amount: totalAmount,
                        price: avgPrice
                    };
                } else {
                    // æ–°å»ºæŒä»“
                    userData.positions.push({
                        market: currentTrade.market,
                        code: item.code,
                        name: item.name,
                        price: price,
                        amount: amount,
                        direction: direction
                    });
                }
                
                // æ£€æŸ¥"å®Œæˆç¬¬ä¸€ç¬”äº¤æ˜“"ä»»åŠ¡
                checkFirstTradeTask();
                
            } else {
                // å–å‡ºé€»è¾‘
                const position = userData.positions[currentTrade.positionIndex];
                
                if (amount > position.amount) {
                    alert("æŒä»“ä¸è¶³");
                    return;
                }
                
                userData.balance += total;
                userData.totalTrades++;
                
                // è®¡ç®—ç›ˆäº
                let profit = 0;
                if (position.direction === 'short') {
                    // ä¹°è·Œçš„ç›ˆåˆ©è®¡ç®—
                    profit = (position.price - price) * amount;
                } else {
                    // ä¹°æ¶¨çš„ç›ˆåˆ©è®¡ç®—
                    profit = (price - position.price) * amount;
                }
                
                userData.todayProfit += profit;
                userData.totalProfit += profit;
                
                if (amount === position.amount) {
                    // å…¨éƒ¨å–å‡ºï¼Œç§»é™¤æŒä»“
                    userData.positions.splice(currentTrade.positionIndex, 1);
                } else {
                    // éƒ¨åˆ†å–å‡ºï¼Œæ›´æ–°æŒä»“
                    userData.positions[currentTrade.positionIndex].amount -= amount;
                }
                
                // æ£€æŸ¥ä¹°æ¶¨/ä¹°è·Œç›ˆåˆ©ä»»åŠ¡
                if (profit > 0) {
                    if (position.direction === 'long') {
                        checkLongProfitTask();
                    } else {
                        checkShortProfitTask();
                    }
                }
            }
            
            // æ›´æ–°ç•Œé¢
            updateAccountInfo();
            renderPositions();
            closeTradeModal();
            
            // æ£€æŸ¥"æŒæœ‰3ç§èµ„äº§"ä»»åŠ¡
            checkDiversifiedPortfolioTask();
            
            // æ£€æŸ¥"æŠ•èµ„æ‰€æœ‰å¸‚åœº"ä»»åŠ¡
            checkAllMarketsTask();
            
            // æ£€æŸ¥"æ€»ç›ˆåˆ©1ä¸‡å…ƒ"ä»»åŠ¡
            checkTotalProfitTask();
        }
        
        // æ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨
        function simulatePriceChanges() {
            // æ›´æ–°è‚¡ç¥¨ä»·æ ¼
            marketData.stocks.forEach(stock => {
                const change = (Math.random() - 0.5) * 4;
                const newPrice = Math.max(0.01, stock.price + change);
                
                // è®°å½•ä»·æ ¼å†å²
                recordPriceHistory('stocks', stock.code, {
                    price: newPrice,
                    open: stock.price,
                    high: Math.max(stock.price, newPrice),
                    low: Math.min(stock.price, newPrice)
                }).catch(error => {
                    console.error("è®°å½•è‚¡ç¥¨ä»·æ ¼å†å²å¤±è´¥:", error);
                });
                
                stock.change += change;
                stock.price = newPrice;
                stock.changePercent = (stock.change / (stock.price - stock.change)) * 100;
            });
            
            // æ›´æ–°åŸºé‡‘ä»·æ ¼
            marketData.funds.forEach(fund => {
                const change = (Math.random() - 0.5) * 0.2;
                const newPrice = Math.max(0.01, fund.price + change);
                
                recordPriceHistory('funds', fund.code, {
                    price: newPrice,
                    open: fund.price,
                    high: Math.max(fund.price, newPrice),
                    low: Math.min(fund.price, newPrice)
                }).catch(error => {
                    console.error("è®°å½•åŸºé‡‘ä»·æ ¼å†å²å¤±è´¥:", error);
                });
                
                fund.change += change;
                fund.price = newPrice;
                fund.changePercent = (fund.change / (fund.price - fund.change)) * 100;
            });
            
            // æ›´æ–°æœŸè´§ä»·æ ¼
            marketData.futures.forEach(future => {
                const change = (Math.random() - 0.5) * (future.price > 100 ? 10 : 2);
                const newPrice = Math.max(0.01, future.price + change);
                
                recordPriceHistory('futures', future.code, {
                    price: newPrice,
                    open: future.price,
                    high: Math.max(future.price, newPrice),
                    low: Math.min(future.price, newPrice)
                }).catch(error => {
                    console.error("è®°å½•æœŸè´§ä»·æ ¼å†å²å¤±è´¥:", error);
                });
                
                future.change += change;
                future.price = newPrice;
                future.changePercent = (future.change / (future.price - future.change)) * 100;
            });
            
            // æ›´æ–°å›½å€ºä»·æ ¼
            marketData.bonds.forEach(bond => {
                const change = (Math.random() - 0.5) * 0.1;
                const newPrice = Math.max(0.01, bond.price + change);
                
                recordPriceHistory('bonds', bond.code, {
                    price: newPrice,
                    open: bond.price,
                    high: Math.max(bond.price, newPrice),
                    low: Math.min(bond.price, newPrice)
                }).catch(error => {
                    console.error("è®°å½•å›½å€ºä»·æ ¼å†å²å¤±è´¥:", error);
                });
                
                bond.change += change;
                bond.price = newPrice;
                bond.changePercent = (bond.change / (bond.price - bond.change)) * 100;
            });
            
            // æ›´æ–°è´§å¸ä»·æ ¼
            marketData.currency.forEach(currency => {
                const change = (Math.random() - 0.5) * (currency.code === 'BTCUSD' ? 500 : 0.01);
                const newPrice = currency.code === 'BTCUSD' ? Math.max(100, currency.price + change) : Math.max(0.0001, currency.price + change);
                
                recordPriceHistory('currency', currency.code, {
                    price: newPrice,
                    open: currency.price,
                    high: Math.max(currency.price, newPrice),
                    low: Math.min(currency.price, newPrice)
                }).catch(error => {
                    console.error("è®°å½•è´§å¸ä»·æ ¼å†å²å¤±è´¥:", error);
                });
                
                currency.change += change;
                currency.price = newPrice;
                currency.changePercent = (currency.change / (currency.price - currency.change)) * 100;
            });
            
            // ä¿å­˜å¸‚åœºæ•°æ®
            Object.keys(marketData).forEach(market => {
                if (market !== 'tasks' && market !== 'milestones') {
                    updateMarketData(market, marketData[market]).catch(error => {
                        console.error(`ä¿å­˜å¸‚åœºæ•°æ® ${market} å¤±è´¥:`, error);
                    });
                }
            });
            
            // é‡æ–°æ¸²æŸ“å¸‚åœºæ•°æ®
            renderMarketData();
            
            // æ›´æ–°æŒä»“æ˜¾ç¤º
            renderPositions();
            
            // æ›´æ–°è´¦æˆ·ä¿¡æ¯
            updateAccountInfo();
            
            // æ£€æŸ¥"æ—¥ç›ˆåˆ©5%"ä»»åŠ¡
            checkDailyProfitTask();
            
            // æ£€æŸ¥"å‘¨ç›ˆåˆ©10%"ä»»åŠ¡
            checkWeeklyProfitTask();
            
            // å¦‚æœå½“å‰åœ¨è¯¦æƒ…é¡µï¼Œæ›´æ–°è¯¦æƒ…é¡µ
            if (currentDetailItem) {
                const item = marketData[currentDetailItem.market].find(
                    item => item.code === currentDetailItem.code
                );
                
                if (item) {
                    elements.detailPrice.textContent = item.price.toFixed(item.price > 100 ? 2 : 4);
                    
                    const changeClass = item.change >= 0 ? "profit-up" : "profit-down";
                    const changeSign = item.change >= 0 ? "+" : "";
                    elements.detailChange.textContent = `${changeSign}${item.change.toFixed(2)} (${changeSign}${item.changePercent.toFixed(2)}%)`;
                    elements.detailChange.className = `detail-change ${changeClass}`;
                    
                    // æ›´æ–°Kçº¿å›¾æœ€æ–°æ•°æ®
                    const chartInfo = {
                        open: item.price,
                        high: item.price,
                        low: item.price,
                        close: item.price
                    };
                    
                    elements.chartOpen.textContent = chartInfo.open.toFixed(4);
                    elements.chartHigh.textContent = chartInfo.high.toFixed(4);
                    elements.chartLow.textContent = chartInfo.low.toFixed(4);
                    elements.chartClose.textContent = chartInfo.close.toFixed(4);
                }
            }
        }
        
        // æ£€æŸ¥é¦–æ¬¡ç™»å½•ä»»åŠ¡
        function checkFirstLoginTask() {
            const task = marketData.tasks.find(t => t.id === 1);
            if (task && !userData.completedTasks.includes(1)) {
                completeTask(1);
            }
        }
        
        // æ£€æŸ¥ç¬¬ä¸€ç¬”äº¤æ˜“ä»»åŠ¡
        function checkFirstTradeTask() {
            const task = marketData.tasks.find(t => t.id === 2);
            if (task && !userData.completedTasks.includes(2) && userData.totalTrades > 0) {
                completeTask(2);
            }
        }
        
        // æ£€æŸ¥äº¤æ˜“æ¬¡æ•°ä»»åŠ¡
        function checkTradeCountTask() {
            const task = marketData.tasks.find(t => t.id === 6);
            if (task && !userData.completedTasks.includes(6) && userData.totalTrades >= 5) {
                completeTask(6);
            }
        }
        
        // æ£€æŸ¥ä¹°æ¶¨ç›ˆåˆ©ä»»åŠ¡
        function checkLongProfitTask() {
            const task = marketData.tasks.find(t => t.id === 7);
            if (task && !userData.completedTasks.includes(7)) {
                // æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡ä¹°æ¶¨ç›ˆåˆ©çš„äº¤æ˜“
                const hasLongProfit = userData.positions.some(p => 
                    p.direction === 'long' && 
                    (getCurrentPrice(p.market, p.code) - p.price) * p.amount > 0
                );
                
                if (hasLongProfit) {
                    completeTask(7);
                }
            }
        }
        
        // æ£€æŸ¥ä¹°è·Œç›ˆåˆ©ä»»åŠ¡
        function checkShortProfitTask() {
            const task = marketData.tasks.find(t => t.id === 8);
            if (task && !userData.completedTasks.includes(8)) {
                // æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡ä¹°è·Œç›ˆåˆ©çš„äº¤æ˜“
                const hasShortProfit = userData.positions.some(p => 
                    p.direction === 'short' && 
                    (p.price - getCurrentPrice(p.market, p.code)) * p.amount > 0
                );
                
                if (hasShortProfit) {
                    completeTask(8);
                }
            }
        }
        
        // æ£€æŸ¥æ€»ç›ˆåˆ©ä»»åŠ¡
        function checkTotalProfitTask() {
            const task = marketData.tasks.find(t => t.id === 9);
            if (task && !userData.completedTasks.includes(9) && userData.totalProfit >= 10000) {
                completeTask(9);
            }
        }
        
        // æ£€æŸ¥å¤šæ ·åŒ–æŠ•èµ„ä»»åŠ¡
        function checkDiversifiedPortfolioTask() {
            const task = marketData.tasks.find(t => t.id === 3);
            if (task && !userData.completedTasks.includes(3)) {
                // ç»Ÿè®¡ä¸åŒç±»å‹çš„èµ„äº§
                const markets = new Set();
                userData.positions.forEach(p => markets.add(p.market));
                
                if (markets.size >= 3) {
                    completeTask(3);
                }
            }
        }
        
        // æ£€æŸ¥æŠ•èµ„æ‰€æœ‰å¸‚åœºä»»åŠ¡
        function checkAllMarketsTask() {
            const task = marketData.tasks.find(t => t.id === 10);
            if (task && !userData.completedTasks.includes(10)) {
                // ç»Ÿè®¡ä¸åŒç±»å‹çš„èµ„äº§
                const markets = new Set();
                userData.positions.forEach(p => markets.add(p.market));
                
                // æ£€æŸ¥æ˜¯å¦æŠ•èµ„äº†æ‰€æœ‰å¸‚åœºç±»å‹
                const allMarkets = ['stocks', 'funds', 'futures', 'bonds', 'currency'];
                const investedAll = allMarkets.every(market => markets.has(market));
                
                if (investedAll) {
                    completeTask(10);
                }
            }
        }
        
        // æ£€æŸ¥æ—¥ç›ˆåˆ©ä»»åŠ¡
        function checkDailyProfitTask() {
            const task = marketData.tasks.find(t => t.id === 4);
            if (task && !userData.completedTasks.includes(4)) {
                // è®¡ç®—æ€»èµ„äº§
                let totalValue = userData.balance;
                userData.positions.forEach(position => {
                    const currentPrice = getCurrentPrice(position.market, position.code);
                    totalValue += currentPrice * position.amount;
                });
                
                // è®¡ç®—ç›ˆåˆ©ç™¾åˆ†æ¯”
                const profitPercentage = (userData.todayProfit / (totalValue - userData.todayProfit)) * 100;
                
                if (profitPercentage >= 5) {
                    completeTask(4);
                }
            }
        }
        
        // æ£€æŸ¥å‘¨ç›ˆåˆ©ä»»åŠ¡
        function checkWeeklyProfitTask() {
            const task = marketData.tasks.find(t => t.id === 5);
            if (task && !userData.completedTasks.includes(5)) {
                // è®¡ç®—æ€»èµ„äº§
                let totalValue = userData.balance;
                userData.positions.forEach(position => {
                    const currentPrice = getCurrentPrice(position.market, position.code);
                    totalValue += currentPrice * position.amount;
                });
                
                // è®¡ç®—ç›ˆåˆ©ç™¾åˆ†æ¯” (ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥è®¡ç®—ä¸€å‘¨çš„ç›ˆåˆ©)
                const profitPercentage = (userData.todayProfit / (totalValue - userData.todayProfit)) * 100;
                
                if (profitPercentage >= 10) {
                    completeTask(5);
                }
            }
        }
        
        // æ£€æŸ¥é‡Œç¨‹ç¢‘
        function checkMilestones() {
            marketData.milestones.forEach(milestone => {
                if (!userData.completedMilestones.includes(milestone.id)) {
                    let completed = false;
                    
                    if (milestone.id <= 4) {
                        // èµ„äº§é‡Œç¨‹ç¢‘
                        let totalValue = userData.balance;
                        userData.positions.forEach(position => {
                            const currentPrice = getCurrentPrice(position.market, position.code);
                            totalValue += currentPrice * position.amount;
                        });
                        
                        completed = totalValue >= milestone.target;
                    } else if (milestone.id === 5) {
                        // äº¤æ˜“æ¬¡æ•°é‡Œç¨‹ç¢‘
                        completed = userData.totalTrades >= milestone.target;
                    } else if (milestone.id === 6) {
                        // ç›ˆåˆ©é‡Œç¨‹ç¢‘
                        completed = userData.totalProfit >= milestone.target;
                    }
                    
                    if (completed) {
                        completeMilestone(milestone.id);
                    }
                }
            });
        }
        
        // å®Œæˆä»»åŠ¡
        function completeTask(taskId) {
            const task = marketData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            userData.completedTasks.push(taskId);
            userData.balance += task.reward;
            
            // æ›´æ–°ä»»åŠ¡çŠ¶æ€
            const taskIndex = marketData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                marketData.tasks[taskIndex].completed = true;
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»»åŠ¡æ•°æ®
                updateMarketData('tasks', marketData.tasks).catch(error => {
                    console.error("æ›´æ–°ä»»åŠ¡æ•°æ®å¤±è´¥:", error);
                });
            }
            
            // æ›´æ–°ç•Œé¢
            updateAccountInfo();
            renderTasks();
            
            // æ˜¾ç¤ºå¥–åŠ±å¼¹çª—
            elements.rewardMessage.textContent = `æ­å–œæ‚¨å®Œæˆä»»åŠ¡ã€${task.name}ã€‘ï¼Œè·å¾—å¥–åŠ± Â¥${task.reward}`;
            elements.rewardModal.style.display = "flex";
        }
        
        // å®Œæˆé‡Œç¨‹ç¢‘
        function completeMilestone(milestoneId) {
            const milestone = marketData.milestones.find(m => m.id === milestoneId);
            if (!milestone) return;
            
            userData.completedMilestones.push(milestoneId);
            userData.balance += milestone.reward;
            
            // æ›´æ–°é‡Œç¨‹ç¢‘çŠ¶æ€
            const milestoneIndex = marketData.milestones.findIndex(m => m.id === milestoneId);
            if (milestoneIndex !== -1) {
                marketData.milestones[milestoneIndex].completed = true;
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„é‡Œç¨‹ç¢‘æ•°æ®
                updateMarketData('milestones', marketData.milestones).catch(error => {
                    console.error("æ›´æ–°é‡Œç¨‹ç¢‘æ•°æ®å¤±è´¥:", error);
                });
            }
            
            // æ›´æ–°ç•Œé¢
            updateAccountInfo();
            renderMilestones();
            
            // æ˜¾ç¤ºé‡Œç¨‹ç¢‘å¼¹çª—
            elements.milestoneMessage.textContent = `æ­å–œæ‚¨è¾¾æˆé‡Œç¨‹ç¢‘ã€${milestone.name}ã€‘ï¼Œè·å¾—å¥–åŠ± Â¥${milestone.reward}`;
            elements.milestoneModal.style.display = "flex";
        }
        
        // é¢†å–ä»»åŠ¡å¥–åŠ±
        function claimTaskReward(taskId) {
            if (!userData.completedTasks.includes(taskId)) {
                completeTask(taskId);
            }
        }
        
        // é¢†å–é‡Œç¨‹ç¢‘å¥–åŠ±
        function claimMilestoneReward(milestoneId) {
            if (!userData.completedMilestones.includes(milestoneId)) {
                completeMilestone(milestoneId);
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        window.onload = initApp;
    </script>
</body>
</html>