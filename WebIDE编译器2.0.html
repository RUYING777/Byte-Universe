<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebIDEç¼–è¯‘å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF9AA2;
            --secondary-color: #FFB7B2;
            --accent-color: #FFDAC1;
            --light-color: #E2F0CB;
            --dark-color: #B5EAD7;
            --text-color: #5E5E5E;
            --sidebar-width: 250px;
            --header-height: 50px;
            --status-height: 25px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Comic Sans MS', 'Marker Felt', 'Arial Rounded MT Bold', sans-serif;
            line-height: 1.6;
            background-color: #f9f9f9;
            color: var(--text-color);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }
        
        h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        h1 i {
            margin-right: 10px;
        }
        
        .container {
            display: flex;
            height: calc(100vh - var(--header-height) - var(--status-height));
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 5;
        }
        
        .sidebar-header {
            padding: 0.8rem;
            background-color: var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .sidebar-controls button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.2rem;
        }
        
        .file-explorer {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .folder {
            margin-bottom: 0.5rem;
        }
        
        .folder-header {
            display: flex;
            align-items: center;
            padding: 0.3rem;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .folder-header:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .folder-icon {
            margin-right: 5px;
            color: var(--primary-color);
        }
        
        .folder-name {
            flex: 1;
        }
        
        .folder-contents {
            padding-left: 20px;
            margin-top: 0.3rem;
            display: none;
        }
        
        .folder.open .folder-contents {
            display: block;
        }
        
        .file {
            display: flex;
            align-items: center;
            padding: 0.3rem;
            padding-left: 25px;
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }
        
        .file:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .file.active {
            background-color: var(--light-color);
            font-weight: bold;
        }
        
        .file-icon {
            margin-right: 5px;
            color: var(--dark-color);
        }
        
        .file-name {
            flex: 1;
        }
        
        .file-actions {
            display: none;
            position: absolute;
            right: 5px;
        }
        
        .file:hover .file-actions {
            display: block;
        }
        
        .file-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.2rem;
        }
        
        .add-btn {
            background-color: var(--dark-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0.5rem auto;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .code-editors {
            display: flex;
            flex-direction: column;
            width: 50%;
            border-right: 1px solid #eee;
        }
        
        .editor-tabs {
            display: flex;
            background: linear-gradient(135deg, var(--light-color), var(--dark-color));
        }
        
        .editor-tab {
            padding: 0.5rem 1rem;
            color: var(--text-color);
            cursor: pointer;
            border-right: 1px solid rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .editor-tab.active {
            background-color: white;
            font-weight: bold;
        }
        
        .editor {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        .preview {
            width: 50%;
            background-color: white;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        
        .preview-header {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--light-color), var(--dark-color));
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .run-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-left: 0.5rem;
        }
        
        .run-btn i {
            margin-right: 5px;
        }
        
        .run-btn:hover {
            background-color: #ff7b85;
        }
        
        .preview-frame {
            flex: 1;
            border: none;
            background-color: white;
        }
        
        .status-bar {
            height: var(--status-height);
            padding: 0 1rem;
            background-color: var(--accent-color);
            color: var(--text-color);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .toggle-sidebar {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .editor-actions {
            display: flex;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .modal-actions button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-secondary {
            background-color: #ddd;
            color: var(--text-color);
        }
        
        /* æ–‡ä»¶å¯¼å…¥åŒºåŸŸ */
        .file-drop-area {
            border: 2px dashed var(--dark-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-drop-area:hover {
            background-color: rgba(181, 234, 215, 0.2);
        }
        
        .file-drop-area i {
            font-size: 2rem;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }
        
        .file-drop-text {
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 0.5rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 0.3rem;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-item-icon {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        
        .file-item-name {
            flex: 1;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 992px) {
            :root {
                --sidebar-width: 200px;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .code-editors, .preview {
                width: 100%;
                height: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: var(--header-height);
                bottom: var(--status-height);
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .logo-icon {
            animation: bounce 2s infinite;
        }
        
        /* æ–‡ä»¶ç±»å‹å›¾æ ‡ */
        .file-icon-img {
            color: #FF9AA2;
        }
        
        .file-icon-doc {
            color: #3498db;
        }
        
        .file-icon-media {
            color: #9b59b6;
        }
        
        .file-icon-archive {
            color: #e67e22;
        }
        
        .file-icon-other {
            color: #95a5a6;
        }
        
        /* ä»£ç æ ¼å¼åŒ–æŒ‰é’® */
        .format-btn {
            background-color: var(--dark-color);
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-left: 0.5rem;
        }
        
        .format-btn:hover {
            background-color: #8fd8b6;
        }
        
        /* é¡¹ç›®æ“ä½œæŒ‰é’® */
        .project-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-left: 0.5rem;
        }
        
        .project-btn:hover {
            background-color: #ff9e9e;
        }
        #delete-project-btn {
            margin-left: 0.5rem;
            background-color: #ff6b6b;
            color: white;
        }

        #delete-project-btn:hover {
            background-color: #ff5252;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-fish logo-icon"></i> WebIDEç¼–è¯‘å™¨</h1>
    </header>
    
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">æ–‡ä»¶èµ„æºç®¡ç†å™¨</div>
                <div class="sidebar-controls">
                    <button title="æ–°å»ºæ–‡ä»¶" id="new-file-btn"><i class="fas fa-plus"></i></button>
                    <button title="å¯¼å…¥æ–‡ä»¶" id="import-file-btn"><i class="fas fa-file-import"></i></button>
                    <button title="åˆ·æ–°" id="refresh-btn"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            
            <div class="file-explorer" id="file-explorer">
                <div class="folder open">
                    <div class="folder-header">
                        <i class="fas fa-folder-open folder-icon"></i>
                        <span class="folder-name">æˆ‘çš„é¡¹ç›®</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="folder-contents">
                        <div class="file active" data-type="html">
                            <i class="fas fa-file-code file-icon"></i>
                            <span class="file-name">index.html</span>
                            <div class="file-actions">
                                <button title="é‡å‘½å"><i class="fas fa-pen"></i></button>
                                <button title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="file" data-type="css">
                            <i class="fas fa-file-code file-icon"></i>
                            <span class="file-name">style.css</span>
                            <div class="file-actions">
                                <button title="é‡å‘½å"><i class="fas fa-pen"></i></button>
                                <button title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="file" data-type="js">
                            <i class="fas fa-file-code file-icon"></i>
                            <span class="file-name">script.js</span>
                            <div class="file-actions">
                                <button title="é‡å‘½å"><i class="fas fa-pen"></i></button>
                                <button title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="folder">
                    <div class="folder-header">
                    </div>
                    <div class="folder-contents"></div>
                </div>
                
                <button class="add-btn" title="ä¿å­˜æ•´ä¸ªé¡¹ç›®" id="save-project-btn"><i class="fas fa-save"></i></button>
                <button class="add-btn" title="åŠ è½½é¡¹ç›®" id="load-project-btn"><i class="fas fa-folder-open"></i></button>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="editor-container">
                <div class="code-editors">
                    <div class="editor-tabs">
                        <div class="editor-tab active" data-target="html">HTML</div>
                        <div class="editor-tab" data-target="css">CSS</div>
                        <div class="editor-tab" data-target="js">JavaScript</div>
                    </div>
                    
                    <div class="editor">
                        <textarea id="html-code" class="code-editor"><!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„ç½‘é¡µ</title>
</head>
<body>
    <h1>æ¬¢è¿ä½¿ç”¨WebIDEç¼–è¯‘å™¨</h1>
    <p>åœ¨è¿™é‡Œç¼–å†™å’Œæµ‹è¯•æ‚¨çš„ä»£ç </p>
    <div id="output"></div>
    <!-- ç¤ºä¾‹å›¾ç‰‡å¼•ç”¨ -->
    <img src="example.jpg" alt="ç¤ºä¾‹å›¾ç‰‡" style="max-width: 300px; display: block; margin: 20px auto;">
</body>
</html></textarea>
                        
                        <textarea id="css-code" class="code-editor">body {
    font-family: 'Comic Sans MS', cursive;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    line-height: 1.6;
    background-color: #f9f9f9;
}

h1 {
    color: #FF9AA2;
    border-bottom: 2px dashed #B5EAD7;
    padding-bottom: 10px;
    text-align: center;
}

p {
    color: #5E5E5E;
}</textarea>
                        
                        <textarea id="js-code" class="code-editor">document.getElementById('output').innerHTML = 
    '<p style="color: #FF9AA2; font-weight: bold;">è¿™æ®µæ–‡å­—æ˜¯ç”±JavaScriptåŠ¨æ€æ·»åŠ çš„~</p>';

console.log('WebIDEç¼–è¯‘å™¨æ­£åœ¨è¿è¡Œæ‚¨çš„ä»£ç ï¼ğŸ‰');</textarea>
                    </div>
                </div>
                
                <div class="preview">
                    <div class="preview-header">
                        <span>å®æ—¶é¢„è§ˆ</span>
                        <div class="editor-actions">
                            <button class="format-btn" id="format-btn"><i class="fas fa-broom"></i> æ ¼å¼åŒ–</button>
                            <button class="project-btn" id="auto-save-btn"><i class="fas fa-save"></i> è‡ªåŠ¨ä¿å­˜</button>
                            <button class="run-btn" id="save-btn"><i class="fas fa-save"></i> å¯¼å‡º</button>
                            <button class="run-btn" id="run-btn"><i class="fas fa-play"></i> è¿è¡Œ</button>
                        </div>
                    </div>
                    <iframe class="preview-frame" id="preview-frame"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¿å­˜æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">å¯¼å‡ºæ–‡ä»¶</span>
                <button class="close-modal" id="close-save-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="filename">æ–‡ä»¶å</label>
                <input type="text" id="filename" placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆä¸å¸¦æ‰©å±•åï¼‰">
            </div>
            <div class="form-group">
                <label for="filetype">æ–‡ä»¶ç±»å‹</label>
                <select id="filetype">
                    <option value="html">HTML (.html)</option>
                    <option value="css">CSS (.css)</option>
                    <option value="js">JavaScript (.js)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancel-save">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-save">å¯¼å‡º</button>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å…¥æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">å¯¼å…¥æ–‡ä»¶</span>
                <button class="close-modal" id="close-import-modal">&times;</button>
            </div>
            <div class="file-drop-area" id="file-drop-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <p class="file-drop-text">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="file-input" style="display: none;" multiple>
            </div>
            <div class="file-list" id="file-list">
                <p style="text-align: center; color: #999;">æš‚æ— æ–‡ä»¶</p>
            </div>
            <div class="form-group">
                <label for="import-folder">å¯¼å…¥åˆ°æ–‡ä»¶å¤¹</label>
                <select id="import-folder">
                    <option value="root">æˆ‘çš„é¡¹ç›®</option>
                    <option value="resources">èµ„æº</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancel-import">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-import">å¯¼å…¥</button>
            </div>
        </div>
    </div>
    
    <!-- ä¿å­˜é¡¹ç›®æ¨¡æ€æ¡† -->
    <div class="modal" id="save-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ä¿å­˜é¡¹ç›®</span>
                <button class="close-modal" id="close-save-project-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="project-name">é¡¹ç›®åç§°</label>
                <input type="text" id="project-name" placeholder="è¾“å…¥é¡¹ç›®åç§°">
            </div>
            <div class="form-group">
                <label for="project-description">é¡¹ç›®æè¿°</label>
                <input type="text" id="project-description" placeholder="è¾“å…¥é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancel-save-project">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-save-project">ä¿å­˜é¡¹ç›®</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½é¡¹ç›®æ¨¡æ€æ¡† -->
    <div class="modal" id="load-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">åŠ è½½é¡¹ç›®</span>
                <button class="close-modal" id="close-load-project-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="project-list">é€‰æ‹©é¡¹ç›®</label>
                <select id="project-list" size="5" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="" disabled selected>åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="project-info">é¡¹ç›®ä¿¡æ¯</label>
                <textarea id="project-info" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" readonly></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancel-load-project">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-load-project">åŠ è½½é¡¹ç›®</button>
                <button class="btn-secondary" id="delete-project-btn" style="background-color: #ff6b6b;"><i class="fas fa-trash"></i> åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å»ºæ–‡ä»¶/æ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div class="modal" id="new-item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="new-item-title">æ–°å»º</span>
                <button class="close-modal" id="close-new-item-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="new-item-name">åç§°</label>
                <input type="text" id="new-item-name" placeholder="è¾“å…¥åç§°">
            </div>
            <div class="form-group" id="new-item-type-container">
                <label for="new-item-type">ç±»å‹</label>
                <select id="new-item-type">
                    <option value="html">HTML (.html)</option>
                    <option value="css">CSS (.css)</option>
                    <option value="js">JavaScript (.js)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancel-new-item">å–æ¶ˆ</button>
                <button class="btn-primary" id="confirm-new-item">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <button class="toggle-sidebar" id="toggle-sidebar"><i class="fas fa-bars"></i></button>
        <span id="status-message">å°±ç»ª - æ¬¢è¿ä½¿ç”¨WebIDEç¼–è¯‘å™¨ï¼</span>
        <span><i class="fas fa-heart" style="color: #FF9AA2;"></i></span>
    </div>

    <!-- å¼•å…¥CodeMirroråº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/formatting/formatting.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    
    <!-- å¼•å…¥JSZipç”¨äºå‹ç¼©é¡¹ç›® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- å¼•å…¥js-beautifyç”¨äºä»£ç æ ¼å¼åŒ– -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // IndexedDBæ•°æ®åº“é…ç½®
            const DB_NAME = 'WebIDE_DB';
            const DB_VERSION = 1;
            const PROJECT_STORE = 'projects';
            const FILE_STORE = 'files';
            const RESOURCE_STORE = 'resources';
            
            let db;
            let currentProjectId = null;
            let autoSaveEnabled = false;
            let autoSaveInterval;
            
            // åˆå§‹åŒ–æ•°æ®åº“
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onerror = function(event) {
                        console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = function(event) {
                        db = event.target.result;
                        console.log('æ•°æ®åº“å·²æ‰“å¼€');
                        resolve(db);
                    };
                    
                    request.onupgradeneeded = function(event) {
                        const db = event.target.result;
                        
                        // åˆ›å»ºé¡¹ç›®å­˜å‚¨
                        if (!db.objectStoreNames.contains(PROJECT_STORE)) {
                            const projectStore = db.createObjectStore(PROJECT_STORE, { 
                                keyPath: 'id',
                                autoIncrement: true 
                            });
                            projectStore.createIndex('name', 'name', { unique: false });
                            projectStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                        
                        // åˆ›å»ºæ–‡ä»¶å­˜å‚¨
                        if (!db.objectStoreNames.contains(FILE_STORE)) {
                            const fileStore = db.createObjectStore(FILE_STORE, { 
                                keyPath: 'id',
                                autoIncrement: true 
                            });
                            fileStore.createIndex('projectId', 'projectId', { unique: false });
                            fileStore.createIndex('name', 'name', { unique: false });
                        }
                        
                        // åˆ›å»ºèµ„æºå­˜å‚¨
                        if (!db.objectStoreNames.contains(RESOURCE_STORE)) {
                            const resourceStore = db.createObjectStore(RESOURCE_STORE, { 
                                keyPath: 'id',
                                autoIncrement: true 
                            });
                            resourceStore.createIndex('projectId', 'projectId', { unique: false });
                            resourceStore.createIndex('name', 'name', { unique: false });
                        }
                        
                        console.log('æ•°æ®åº“ç»“æ„å·²åˆ›å»º');
                    };
                });
            }
            
            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-code'), {
                mode: 'htmlmixed',
                theme: 'material-darker',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                autoCloseTags: true,
                autoCloseBrackets: true,
                matchTags: {bothTags: true},
                matchBrackets: true,
                lineWrapping: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-/": "toggleComment",
                    "Ctrl-Alt-L": function(cm) { formatCode(cm, 'html'); },
                    "'<'": function(cm) { cm.closeTag(cm, '>'); },
                    "Tab": "indentMore",
                    "Shift-Tab": "indentLess"
                }
            });
            
            const cssEditor = CodeMirror.fromTextArea(document.getElementById('css-code'), {
                mode: 'css',
                theme: 'material-darker',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                autoCloseBrackets: true,
                matchBrackets: true,
                lineWrapping: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-/": "toggleComment",
                    "Ctrl-Alt-L": function(cm) { formatCode(cm, 'css'); },
                    "Tab": "indentMore",
                    "Shift-Tab": "indentLess"
                }
            });
            
            const jsEditor = CodeMirror.fromTextArea(document.getElementById('js-code'), {
                mode: 'javascript',
                theme: 'material-darker',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                autoCloseBrackets: true,
                matchBrackets: true,
                lineWrapping: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-/": "toggleComment",
                    "Ctrl-Alt-L": function(cm) { formatCode(cm, 'js'); },
                    "Tab": "indentMore",
                    "Shift-Tab": "indentLess"
                }
            });
            
            // ä»£ç æ ¼å¼åŒ–å‡½æ•°
            function formatCode(editor, type) {
                const code = editor.getValue();
                let formattedCode = code;
                
                try {
                    if (type === 'html') {
                        formattedCode = html_beautify(code, {
                            indent_size: 4,
                            indent_char: ' ',
                            max_preserve_newlines: 2,
                            preserve_newlines: true,
                            keep_array_indentation: false,
                            break_chained_methods: false,
                            indent_scripts: 'normal',
                            brace_style: 'collapse',
                            space_before_conditional: true,
                            unescape_strings: false,
                            jslint_happy: false,
                            end_with_newline: true,
                            wrap_line_length: 0,
                            indent_inner_html: true,
                            comma_first: false,
                            e4x: false,
                            indent_empty_lines: false
                        });
                    } else if (type === 'css') {
                        formattedCode = css_beautify(code, {
                            indent_size: 4,
                            indent_char: ' ',
                            selector_separator_newline: true,
                            newline_between_rules: true,
                            preserve_newlines: true,
                            end_with_newline: true
                        });
                    } else if (type === 'js') {
                        formattedCode = js_beautify(code, {
                            indent_size: 4,
                            indent_char: ' ',
                            max_preserve_newlines: 2,
                            preserve_newlines: true,
                            keep_array_indentation: false,
                            break_chained_methods: false,
                            indent_scripts: 'normal',
                            brace_style: 'collapse',
                            space_before_conditional: true,
                            unescape_strings: false,
                            jslint_happy: false,
                            end_with_newline: true,
                            wrap_line_length: 0,
                            comma_first: false,
                            e4x: false,
                            indent_empty_lines: false
                        });
                    }
                    
                    editor.setValue(formattedCode);
                    statusBar.textContent = 'ä»£ç å·²æ ¼å¼åŒ– - ' + new Date().toLocaleTimeString();
                } catch (e) {
                    console.error('æ ¼å¼åŒ–é”™è¯¯:', e);
                    statusBar.textContent = 'æ ¼å¼åŒ–é”™è¯¯: ' + e.message;
                }
            }
            
            // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
            const tabs = document.querySelectorAll('.editor-tab');
            const editors = [htmlEditor, cssEditor, jsEditor];
            
            tabs.forEach((tab, index) => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    editors.forEach(editor => editor.getWrapperElement().style.display = 'none');
                    editors[index].getWrapperElement().style.display = 'block';
                    editors[index].refresh();
                });
            });
            
            // é»˜è®¤æ˜¾ç¤ºHTMLç¼–è¾‘å™¨
            cssEditor.getWrapperElement().style.display = 'none';
            jsEditor.getWrapperElement().style.display = 'none';
            
            // è¿è¡ŒæŒ‰é’®åŠŸèƒ½
            const runBtn = document.getElementById('run-btn');
            const saveBtn = document.getElementById('save-btn');
            const formatBtn = document.getElementById('format-btn');
            const autoSaveBtn = document.getElementById('auto-save-btn');
            const previewFrame = document.getElementById('preview-frame');
            const statusBar = document.getElementById('status-message');

            
            // å­˜å‚¨å¯¼å…¥çš„èµ„æºæ–‡ä»¶
            const importedResources = {};
            
            function runCode() {
                const html = htmlEditor.getValue();
                const css = cssEditor.getValue();
                const js = jsEditor.getValue();
                
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                previewDoc.open();
                previewDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>${css}</style>
                    </head>
                    <body>
                        ${html}
                        <script>${js}<\/script>
                    </body>
                    </html>
                `);
                previewDoc.close();
                
                // æ³¨å…¥å¯¼å…¥çš„èµ„æºæ–‡ä»¶
                Object.keys(importedResources).forEach(filename => {
                    if (filename.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i)) {
                        // å›¾ç‰‡èµ„æº
                        const imgElements = previewDoc.querySelectorAll(`img[src="${filename}"]`);
                        imgElements.forEach(img => {
                            img.src = importedResources[filename];
                        });
                    } else if (filename.match(/\.(mp3|wav|ogg)$/i)) {
                        // éŸ³é¢‘èµ„æº
                        const audioElements = previewDoc.querySelectorAll(`audio source[src="${filename}"], audio[src="${filename}"]`);
                        audioElements.forEach(audio => {
                            audio.src = importedResources[filename];
                        });
                    } else if (filename.match(/\.(mp4|webm|ogv)$/i)) {
                        // è§†é¢‘èµ„æº
                        const videoElements = previewDoc.querySelectorAll(`video source[src="${filename}"], video[src="${filename}"]`);
                        videoElements.forEach(video => {
                            video.src = importedResources[filename];
                        });
                    }
                });
                
                statusBar.textContent = 'ä»£ç å·²æ‰§è¡Œ - ' + new Date().toLocaleTimeString();
            }
            
            // æ–°æ·»åŠ çš„è¿è¡Œé¡µé¢åŠŸèƒ½
            function runInNewPage() {
                const html = htmlEditor.getValue();
                const css = cssEditor.getValue();
                const js = jsEditor.getValue();
                
                // åˆ›å»ºæ–°çª—å£
                const newWindow = window.open('', '_blank');
                
                // å†™å…¥HTMLå†…å®¹
                newWindow.document.open();
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>WebIDE è¿è¡Œç»“æœ</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 0; 
                                padding: 20px;
                                background-color: #f5f5f5;
                            }
                            .header {
                                background-color: #FF9AA2;
                                color: white;
                                padding: 10px;
                                margin-bottom: 20px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .close-btn {
                                background-color: white;
                                color: #FF9AA2;
                                border: none;
                                padding: 5px 10px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                            }
                            ${css}
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>WebIDE è¿è¡Œç»“æœ</h2>
                            <button class="close-btn" onclick="window.close()">å…³é—­</button>
                        </div>
                        ${html}
                        <script>${js}<\/script>
                    </body>
                    </html>
                `);
                newWindow.document.close();
                
                // æ³¨å…¥å¯¼å…¥çš„èµ„æºæ–‡ä»¶
                Object.keys(importedResources).forEach(filename => {
                    if (filename.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i)) {
                        // å›¾ç‰‡èµ„æº
                        const imgElements = newWindow.document.querySelectorAll(`img[src="${filename}"]`);
                        imgElements.forEach(img => {
                            img.src = importedResources[filename];
                        });
                    } else if (filename.match(/\.(mp3|wav|ogg)$/i)) {
                        // éŸ³é¢‘èµ„æº
                        const audioElements = newWindow.document.querySelectorAll(`audio source[src="${filename}"], audio[src="${filename}"]`);
                        audioElements.forEach(audio => {
                            audio.src = importedResources[filename];
                        });
                    } else if (filename.match(/\.(mp4|webm|ogv)$/i)) {
                        // è§†é¢‘èµ„æº
                        const videoElements = newWindow.document.querySelectorAll(`video source[src="${filename}"], video[src="${filename}"]`);
                        videoElements.forEach(video => {
                            video.src = importedResources[filename];
                        });
                    }
                });
                
                statusBar.textContent = 'ä»£ç å·²åœ¨æ–°çª—å£è¿è¡Œ - ' + new Date().toLocaleTimeString();
            }
            
            // ä¿®æ”¹è¿è¡ŒæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            runBtn.addEventListener('click', runInNewPage);
            
            // æ ¼å¼åŒ–æŒ‰é’®åŠŸèƒ½
            formatBtn.addEventListener('click', function() {
                let activeEditor;
                let type;
                
                if (htmlEditor.getWrapperElement().style.display !== 'none') {
                    activeEditor = htmlEditor;
                    type = 'html';
                } else if (cssEditor.getWrapperElement().style.display !== 'none') {
                    activeEditor = cssEditor;
                    type = 'css';
                } else {
                    activeEditor = jsEditor;
                    type = 'js';
                }
                
                formatCode(activeEditor, type);
            });
            
            // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
            autoSaveBtn.addEventListener('click', function() {
                autoSaveEnabled = !autoSaveEnabled;
                
                if (autoSaveEnabled) {
                    autoSaveBtn.innerHTML = '<i class="fas fa-save"></i> è‡ªåŠ¨ä¿å­˜ä¸­';
                    autoSaveBtn.style.backgroundColor = '#4CAF50';
                    statusBar.textContent = 'è‡ªåŠ¨ä¿å­˜å·²å¯ç”¨';
                    
                    // ç«‹å³ä¿å­˜ä¸€æ¬¡
                    saveCurrentProject();
                    
                    // è®¾ç½®å®šæ—¶ä¿å­˜
                    autoSaveInterval = setInterval(saveCurrentProject, 30000); // æ¯30ç§’ä¿å­˜ä¸€æ¬¡
                } else {
                    autoSaveBtn.innerHTML = '<i class="fas fa-save"></i> è‡ªåŠ¨ä¿å­˜';
                    autoSaveBtn.style.backgroundColor = '';
                    statusBar.textContent = 'è‡ªåŠ¨ä¿å­˜å·²ç¦ç”¨';
                    clearInterval(autoSaveInterval);
                }
            });
            
            // è‡ªåŠ¨è¿è¡Œï¼ˆå¯é€‰ï¼‰
            let timeout;
            [htmlEditor, cssEditor, jsEditor].forEach(editor => {
                editor.on('change', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(runCode, 1000);
                    statusBar.textContent = 'ä»£ç å·²æ›´æ”¹...';
                    
                    // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨ä¿å­˜ï¼Œä¿å­˜å½“å‰é¡¹ç›®
                    if (autoSaveEnabled) {
                        saveCurrentProject();
                    }
                });
            });
            
            // æ–‡ä»¶å¤¹åŠŸèƒ½
            const folders = document.querySelectorAll('.folder-header');
            folders.forEach(folder => {
                folder.addEventListener('click', () => {
                    const parentFolder = folder.parentElement;
                    parentFolder.classList.toggle('open');
                    
                    const icon = folder.querySelector('.fa-chevron-right, .fa-chevron-down');
                    if (icon.classList.contains('fa-chevron-right')) {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    }
                });
            });
            
            // æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
            const files = document.querySelectorAll('.file');
            files.forEach(file => {
                file.addEventListener('click', (e) => {
                    // é˜²æ­¢ç‚¹å‡»æ“ä½œæŒ‰é’®æ—¶è§¦å‘
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') {
                        return;
                    }
                    
                    document.querySelectorAll('.file').forEach(f => f.classList.remove('active'));
                    file.classList.add('active');
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½æ–‡ä»¶å†…å®¹çš„é€»è¾‘
                    statusBar.textContent = 'å·²é€‰æ‹©: ' + file.querySelector('.file-name').textContent;
                });
            });
            
            // ä¾§è¾¹æ åˆ‡æ¢
            const toggleSidebar = document.getElementById('toggle-sidebar');
            const sidebar = document.getElementById('sidebar');
            
            toggleSidebar.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
            
            // ä¿å­˜åŠŸèƒ½
            const saveModal = document.getElementById('save-modal');
            const closeSaveModal = document.getElementById('close-save-modal');
            const cancelSave = document.getElementById('cancel-save');
            const confirmSave = document.getElementById('confirm-save');
            const filenameInput = document.getElementById('filename');
            const filetypeSelect = document.getElementById('filetype');

            // æ–°å¢å¯¼å‡ºé¡¹ç›®æŒ‰é’®
            const exportProjectBtn = document.createElement('button');
            exportProjectBtn.className = 'project-btn';
            exportProjectBtn.id = 'export-project-btn';
            exportProjectBtn.innerHTML = '<i class="fas fa-folder-open"></i> å¯¼å‡ºé¡¹ç›®';
            document.querySelector('.editor-actions').appendChild(exportProjectBtn);
            
            saveBtn.addEventListener('click', () => {
                // è·å–å½“å‰æ´»åŠ¨çš„ç¼–è¾‘å™¨å†…å®¹
                let activeEditor;
                let defaultFilename = 'untitled';
                let defaultType = 'html';
                
                if (htmlEditor.getWrapperElement().style.display !== 'none') {
                    activeEditor = htmlEditor;
                    defaultType = 'html';
                } else if (cssEditor.getWrapperElement().style.display !== 'none') {
                    activeEditor = cssEditor;
                    defaultType = 'css';
                } else {
                    activeEditor = jsEditor;
                    defaultType = 'js';
                }
                
                // è®¾ç½®é»˜è®¤æ–‡ä»¶åå’Œç±»å‹
                filenameInput.value = defaultFilename;
                filetypeSelect.value = defaultType;
                
                saveModal.style.display = 'flex';
            });

            // å¯¼å‡ºæ•´ä¸ªé¡¹ç›®åŠŸèƒ½
            exportProjectBtn.addEventListener('click', async () => {
                if (!currentProjectId) {
                    alert('è¯·å…ˆä¿å­˜é¡¹ç›®ï¼');
                    return;
                }

                try {
                    // è·å–é¡¹ç›®åç§°
                    const project = await getProjectFromDB(currentProjectId);
                    const projectName = project.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    
                    // è·å–é¡¹ç›®æ‰€æœ‰æ–‡ä»¶
                    const files = await getFilesFromDB(currentProjectId);
                    const resources = await getResourcesFromDB(currentProjectId);
                    
                    // åˆ›å»ºJSZipå®ä¾‹
                    const zip = new JSZip();
                    
                    // æ·»åŠ æ–‡ä»¶åˆ°zip
                    files.forEach(file => {
                        zip.file(file.name, file.content);
                    });
                    
                    // æ·»åŠ èµ„æºæ–‡ä»¶åˆ°zip
                    resources.forEach(resource => {
                        // ä»DataURLä¸­æå–Base64æ•°æ®
                        const base64Data = resource.content.split(',')[1];
                        zip.file(resource.name, base64Data, {base64: true});
                    });
                    
                    // ç”Ÿæˆzipæ–‡ä»¶
                    const content = await zip.generateAsync({type: 'blob'});
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = `${projectName}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    statusBar.textContent = `é¡¹ç›®å·²å¯¼å‡º: ${projectName}.zip - ${new Date().toLocaleTimeString()}`;
                } catch (error) {
                    console.error('å¯¼å‡ºé¡¹ç›®å¤±è´¥:', error);
                    statusBar.textContent = 'å¯¼å‡ºé¡¹ç›®å¤±è´¥: ' + error.message;
                }
            });
            
            closeSaveModal.addEventListener('click', () => {
                saveModal.style.display = 'none';
            });
            
            cancelSave.addEventListener('click', () => {
                saveModal.style.display = 'none';
            });
            
            confirmSave.addEventListener('click', () => {
                const filename = filenameInput.value.trim();
                const filetype = filetypeSelect.value;
                
                if (!filename) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ–‡ä»¶åï¼');
                    return;
                }
                
                // è·å–å½“å‰æ´»åŠ¨ç¼–è¾‘å™¨çš„å†…å®¹
                let content;
                if (filetype === 'html') {
                    content = htmlEditor.getValue();
                } else if (filetype === 'css') {
                    content = cssEditor.getValue();
                } else {
                    content = jsEditor.getValue();
                }
                
                // åˆ›å»ºå®Œæ•´çš„æ–‡ä»¶å
                const fullFilename = filename + '.' + filetype;
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([content], { type: 'text/plain' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fullFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // æ›´æ–°çŠ¶æ€æ 
                statusBar.textContent = `æ–‡ä»¶å·²ä¿å­˜: ${fullFilename} - ${new Date().toLocaleTimeString()}`;
                
                // å…³é—­æ¨¡æ€æ¡†
                saveModal.style.display = 'none';
                
                // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
                addFileToExplorer(fullFilename, filetype);
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                if (currentProjectId) {
                    saveFileToDB(currentProjectId, fullFilename, content, filetype);
                }
            });
            
            // æ·»åŠ æ–‡ä»¶åˆ°èµ„æºç®¡ç†å™¨
            function addFileToExplorer(filename, filetype) {
                const fileExplorer = document.getElementById('file-explorer');
                const firstFolder = fileExplorer.querySelector('.folder-contents');
                
                const fileElement = document.createElement('div');
                fileElement.className = 'file';
                fileElement.dataset.type = filetype;
                
                fileElement.innerHTML = `
                    <i class="fas fa-file-code file-icon"></i>
                    <span class="file-name">${filename}</span>
                    <div class="file-actions">
                        <button title="é‡å‘½å"><i class="fas fa-pen"></i></button>
                        <button title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                firstFolder.appendChild(fileElement);
                
                // æ–‡ä»¶ç‚¹å‡»äº‹ä»¶
                fileElement.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') {
                        return;
                    }
                    
                    document.querySelectorAll('.file').forEach(f => f.classList.remove('active'));
                    fileElement.classList.add('active');
                    statusBar.textContent = 'å·²é€‰æ‹©: ' + filename;
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = fileElement.querySelector('.file-actions button:last-child');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${filename} å—ï¼Ÿ`)) {
                        fileElement.remove();
                        if (currentProjectId) {
                            deleteFileFromDB(currentProjectId, filename).then(() => {
                                statusBar.textContent = `æ–‡ä»¶å·²åˆ é™¤: ${filename}`;
                            }).catch(error => {
                                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                                statusBar.textContent = 'åˆ é™¤æ–‡ä»¶å¤±è´¥: ' + error.message;
                            });
                        }
                    }
                });
                
                // é‡å‘½åæŒ‰é’®äº‹ä»¶ (å¯é€‰)
                const renameBtn = fileElement.querySelector('.file-actions button:first-child');
                renameBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const newName = prompt('è¾“å…¥æ–°çš„æ–‡ä»¶å:', filename);
                    if (newName && newName !== filename) {
                        // å®ç°é‡å‘½åé€»è¾‘
                    }
                });
            }
            
            // å¯¼å…¥æ–‡ä»¶åŠŸèƒ½
            const importBtn = document.getElementById('import-file-btn');
            const importModal = document.getElementById('import-modal');
            const closeImportModal = document.getElementById('close-import-modal');
            const cancelImport = document.getElementById('cancel-import');
            const confirmImport = document.getElementById('confirm-import');
            const fileDropArea = document.getElementById('file-drop-area');
            const fileInput = document.getElementById('file-input');
            const fileList = document.getElementById('file-list');
            const importFolderSelect = document.getElementById('import-folder');
            
            let filesToImport = [];
            
            importBtn.addEventListener('click', () => {
                filesToImport = [];
                fileList.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— æ–‡ä»¶</p>';
                importModal.style.display = 'flex';
            });
            
            closeImportModal.addEventListener('click', () => {
                importModal.style.display = 'none';
            });
            
            cancelImport.addEventListener('click', () => {
                importModal.style.display = 'none';
            });
            
            // å¤„ç†æ–‡ä»¶æ‹–æ”¾
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropArea.style.backgroundColor = 'rgba(181, 234, 215, 0.2)';
            });
            
            fileDropArea.addEventListener('dragleave', () => {
                fileDropArea.style.backgroundColor = '';
            });
            
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            fileDropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleFiles(fileInput.files);
                }
            });
            
            function handleFiles(files) {
                filesToImport = Array.from(files);
                updateFileList();
            }
            
            function updateFileList() {
                if (filesToImport.length === 0) {
                    fileList.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— æ–‡ä»¶</p>';
                    return;
                }
                
                fileList.innerHTML = '';
                
                filesToImport.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©å›¾æ ‡
                    let iconClass = 'fa-file';
                    if (file.type.startsWith('image/')) {
                        iconClass = 'fa-file-image file-icon-img';
                    } else if (file.type.startsWith('text/') || file.type === 'application/javascript' || file.type === 'text/css') {
                        iconClass = 'fa-file-code';
                    } else if (file.type.startsWith('audio/') || file.type.startsWith('video/')) {
                        iconClass = 'fa-file-video file-icon-media';
                    } else if (file.type === 'application/pdf' || file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        iconClass = 'fa-file-word file-icon-doc';
                    } else if (file.type === 'application/zip' || file.type === 'application/x-rar-compressed') {
                        iconClass = 'fa-file-archive file-icon-archive';
                    } else {
                        iconClass = 'fa-file file-icon-other';
                    }
                    
                    fileItem.innerHTML = `
                        <i class="fas ${iconClass} file-item-icon"></i>
                        <span class="file-item-name" title="${file.name}">${file.name}</span>
                        <button class="file-item-remove" data-index="${index}"><i class="fas fa-times"></i></button>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.file-item-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        filesToImport.splice(index, 1);
                        updateFileList();
                    });
                });
            }
            
            confirmImport.addEventListener('click', () => {
                if (filesToImport.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶ï¼');
                    return;
                }
                
                const folder = importFolderSelect.value;
                const folderElement = folder === 'root' 
                    ? document.querySelector('.folder-contents')
                    : document.querySelectorAll('.folder-contents')[1];
                
                filesToImport.forEach(file => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'file';
                        fileElement.dataset.type = getFileType(file.name);
                        
                        // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©å›¾æ ‡
                        let iconClass = 'fa-file';
                        if (file.type.startsWith('image/')) {
                            iconClass = 'fa-file-image file-icon-img';
                        } else if (file.type.startsWith('text/') || file.type === 'application/javascript' || file.type === 'text/css') {
                            iconClass = 'fa-file-code';
                        } else if (file.type.startsWith('audio/') || file.type.startsWith('video/')) {
                            iconClass = 'fa-file-video file-icon-media';
                        } else if (file.type === 'application/pdf' || file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                            iconClass = 'fa-file-word file-icon-doc';
                        } else if (file.type === 'application/zip' || file.type === 'application/x-rar-compressed') {
                            iconClass = 'fa-file-archive file-icon-archive';
                        } else {
                            iconClass = 'fa-file file-icon-other';
                        }
                        
                        fileElement.innerHTML = `
                            <i class="fas ${iconClass} file-icon"></i>
                            <span class="file-name">${file.name}</span>
                            <div class="file-actions">
                                <button title="é‡å‘½å"><i class="fas fa-pen"></i></button>
                                <button title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        
                        folderElement.appendChild(fileElement);
                        
                        // å­˜å‚¨æ–‡ä»¶æ•°æ®ä»¥ä¾¿é¢„è§ˆ
                        importedResources[file.name] = e.target.result;
                        
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        if (currentProjectId) {
                            if (file.type.startsWith('text/') || file.type === 'application/javascript' || file.type === 'text/css') {
                                // æ–‡æœ¬æ–‡ä»¶
                                saveFileToDB(currentProjectId, file.name, e.target.result, getFileType(file.name));
                            } else {
                                // äºŒè¿›åˆ¶æ–‡ä»¶
                                saveResourceToDB(currentProjectId, file.name, e.target.result, file.type);
                            }
                        }
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        fileElement.addEventListener('click', function(e) {
                            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') {
                                return;
                            }
                            
                            document.querySelectorAll('.file').forEach(f => f.classList.remove('active'));
                            fileElement.classList.add('active');
                            
                            // å¦‚æœæ˜¯å›¾ç‰‡ã€è§†é¢‘æˆ–éŸ³é¢‘æ–‡ä»¶ï¼Œåœ¨é¢„è§ˆä¸­æ˜¾ç¤º
                            if (file.type.startsWith('image/') || file.type.startsWith('audio/') || file.type.startsWith('video/')) {
                                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                                previewDoc.open();
                                previewDoc.write(`
                                    <!DOCTYPE html>
                                    <html>
                                    <head>
                                        <style>
                                            body { 
                                                display: flex; 
                                                justify-content: center; 
                                                align-items: center; 
                                                height: 100vh; 
                                                margin: 0; 
                                                background-color: #f5f5f5;
                                            }
                                            .preview-container {
                                                text-align: center;
                                                max-width: 90%;
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="preview-container">
                                            <h2>${file.name}</h2>
                                            ${file.type.startsWith('image/') ? `<img src="${e.target.result}" style="max-width: 100%; max-height: 80vh;">` : ''}
                                            ${file.type.startsWith('audio/') ? `<audio controls src="${e.target.result}"></audio>` : ''}
                                            ${file.type.startsWith('video/') ? `<video controls src="${e.target.result}" style="max-width: 100%; max-height: 80vh;"></video>` : ''}
                                        </div>
                                    </body>
                                    </html>
                                `);
                                previewDoc.close();
                            }
                            
                            statusBar.textContent = 'å·²é€‰æ‹©: ' + file.name;
                        });
                    };
                    
                    if (file.type.startsWith('text/') || file.type === 'application/javascript' || file.type === 'text/css') {
                        reader.readAsText(file);
                    } else {
                        reader.readAsDataURL(file);
                    }
                });
                
                statusBar.textContent = `å·²å¯¼å…¥ ${filesToImport.length} ä¸ªæ–‡ä»¶`;
                importModal.style.display = 'none';
                filesToImport = [];
            });
            
            function getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                if (ext === 'html' || ext === 'htm') return 'html';
                if (ext === 'css') return 'css';
                if (ext === 'js') return 'js';
                return 'other';
            }
            
            // ä¿å­˜é¡¹ç›®åŠŸèƒ½
            const saveProjectBtn = document.getElementById('save-project-btn');
            const saveProjectModal = document.getElementById('save-project-modal');
            const closeSaveProjectModal = document.getElementById('close-save-project-modal');
            const cancelSaveProject = document.getElementById('cancel-save-project');
            const confirmSaveProject = document.getElementById('confirm-save-project');
            const projectNameInput = document.getElementById('project-name');
            const projectDescriptionInput = document.getElementById('project-description');
            
            saveProjectBtn.addEventListener('click', () => {
                projectNameInput.value = 'æˆ‘çš„é¡¹ç›®';
                projectDescriptionInput.value = '';
                saveProjectModal.style.display = 'flex';
            });
            
            closeSaveProjectModal.addEventListener('click', () => {
                saveProjectModal.style.display = 'none';
            });
            
            cancelSaveProject.addEventListener('click', () => {
                saveProjectModal.style.display = 'none';
            });
            
            confirmSaveProject.addEventListener('click', () => {
                const projectName = projectNameInput.value.trim();
                const projectDescription = projectDescriptionInput.value.trim();
                
                if (!projectName) {
                    alert('è¯·è¾“å…¥é¡¹ç›®åç§°ï¼');
                    return;
                }
                
                // åˆ›å»ºé¡¹ç›®å¯¹è±¡
                const project = {
                    name: projectName,
                    description: projectDescription,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // ä¿å­˜é¡¹ç›®åˆ°æ•°æ®åº“
                saveProjectToDB(project).then(projectId => {
                    currentProjectId = projectId;
                    statusBar.textContent = `é¡¹ç›®å·²ä¿å­˜: ${projectName} - ${new Date().toLocaleTimeString()}`;
                    saveProjectModal.style.display = 'none';
                    
                    // ä¿å­˜å½“å‰æ–‡ä»¶å†…å®¹
                    saveCurrentProject();
                }).catch(error => {
                    console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', error);
                    statusBar.textContent = 'ä¿å­˜é¡¹ç›®å¤±è´¥: ' + error.message;
                });
            });
            
            // åŠ è½½é¡¹ç›®åŠŸèƒ½
            const loadProjectBtn = document.getElementById('load-project-btn');
            const loadProjectModal = document.getElementById('load-project-modal');
            const closeLoadProjectModal = document.getElementById('close-load-project-modal');
            const cancelLoadProject = document.getElementById('cancel-load-project');
            const confirmLoadProject = document.getElementById('confirm-load-project');
            const projectList = document.getElementById('project-list');
            const projectInfo = document.getElementById('project-info');
            const deleteProjectBtn = document.getElementById('delete-project-btn');
            
            loadProjectBtn.addEventListener('click', () => {
                loadProjectModal.style.display = 'flex';
                loadProjectsList();
            });
            
            closeLoadProjectModal.addEventListener('click', () => {
                loadProjectModal.style.display = 'none';
            });
            
            cancelLoadProject.addEventListener('click', () => {
                loadProjectModal.style.display = 'none';
            });
            
            confirmLoadProject.addEventListener('click', () => {
                const selectedProjectId = projectList.value;
                
                if (!selectedProjectId) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®ï¼');
                    return;
                }
                
                loadProjectFromDB(selectedProjectId).then(() => {
                    loadProjectModal.style.display = 'none';
                    statusBar.textContent = `é¡¹ç›®å·²åŠ è½½ - ${new Date().toLocaleTimeString()}`;
                }).catch(error => {
                    console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                    statusBar.textContent = 'åŠ è½½é¡¹ç›®å¤±è´¥: ' + error.message;
                });
            });
            
            deleteProjectBtn.addEventListener('click', () => {
                const selectedProjectId = projectList.value;
                
                if (!selectedProjectId) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®ï¼');
                    return;
                }
                
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    deleteProjectFromDB(selectedProjectId).then(() => {
                        statusBar.textContent = `é¡¹ç›®å·²åˆ é™¤ - ${new Date().toLocaleTimeString()}`;
                        loadProjectsList();
                    }).catch(error => {
                        console.error('åˆ é™¤é¡¹ç›®å¤±è´¥:', error);
                        statusBar.textContent = 'åˆ é™¤é¡¹ç›®å¤±è´¥: ' + error.message;
                    });
                }
            });
            
            projectList.addEventListener('change', () => {
                const selectedProjectId = projectList.value;
                
                if (selectedProjectId) {
                    getProjectFromDB(selectedProjectId).then(project => {
                        projectInfo.value = `åç§°: ${project.name}\næè¿°: ${project.description || 'æ— '}\nåˆ›å»ºæ—¶é—´: ${new Date(project.createdAt).toLocaleString()}\næ›´æ–°æ—¶é—´: ${new Date(project.updatedAt).toLocaleString()}`;
                    });
                } else {
                    projectInfo.value = '';
                }
            });
            
            // åˆ·æ–°æŒ‰é’®åŠŸèƒ½
            const refreshBtn = document.getElementById('refresh-btn');
            
            refreshBtn.addEventListener('click', () => {
                if (currentProjectId) {
                    loadProjectFromDB(currentProjectId).then(() => {
                        statusBar.textContent = `é¡¹ç›®å·²åˆ·æ–° - ${new Date().toLocaleTimeString()}`;
                    }).catch(error => {
                        console.error('åˆ·æ–°é¡¹ç›®å¤±è´¥:', error);
                        statusBar.textContent = 'åˆ·æ–°é¡¹ç›®å¤±è´¥: ' + error.message;
                    });
                } else {
                    statusBar.textContent = 'æ²¡æœ‰å½“å‰é¡¹ç›®å¯åˆ·æ–°';
                }
            });
            
            // IndexedDBæ“ä½œå‡½æ•°
            function saveProjectToDB(project) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([PROJECT_STORE], 'readwrite');
                    const store = transaction.objectStore(PROJECT_STORE);
                    
                    const request = store.add(project);
                    
                    request.onsuccess = function(event) {
                        resolve(event.target.result); // è¿”å›é¡¹ç›®ID
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function updateProjectInDB(projectId, project) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([PROJECT_STORE], 'readwrite');
                    const store = transaction.objectStore(PROJECT_STORE);
                    
                    // å…ˆè·å–é¡¹ç›®ï¼Œå†æ›´æ–°
                    const getRequest = store.get(projectId);
                    
                    getRequest.onsuccess = function() {
                        const existingProject = getRequest.result;
                        if (existingProject) {
                            // æ›´æ–°é¡¹ç›®ä¿¡æ¯
                            existingProject.name = project.name || existingProject.name;
                            existingProject.description = project.description || existingProject.description;
                            existingProject.updatedAt = new Date().toISOString();
                            
                            const updateRequest = store.put(existingProject);
                            
                            updateRequest.onsuccess = function() {
                                resolve();
                            };
                            
                            updateRequest.onerror = function(event) {
                                reject(event.target.error);
                            };
                        } else {
                            reject(new Error('é¡¹ç›®ä¸å­˜åœ¨'));
                        }
                    };
                    
                    getRequest.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function getProjectFromDB(projectId) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([PROJECT_STORE], 'readonly');
                    const store = transaction.objectStore(PROJECT_STORE);
                    
                    const request = store.get(projectId);
                    
                    request.onsuccess = function() {
                        if (request.result) {
                            resolve(request.result);
                        } else {
                            reject(new Error('é¡¹ç›®ä¸å­˜åœ¨'));
                        }
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function getAllProjectsFromDB() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([PROJECT_STORE], 'readonly');
                    const store = transaction.objectStore(PROJECT_STORE);
                    
                    const request = store.getAll();
                    
                    request.onsuccess = function() {
                        resolve(request.result);
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function deleteProjectFromDB(projectId) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([PROJECT_STORE, FILE_STORE, RESOURCE_STORE], 'readwrite');
                    const projectStore = transaction.objectStore(PROJECT_STORE);
                    const fileStore = transaction.objectStore(FILE_STORE);
                    const resourceStore = transaction.objectStore(RESOURCE_STORE);
                    
                    // åˆ é™¤é¡¹ç›®
                    const deleteProjectRequest = projectStore.delete(projectId);
                    
                    // åˆ é™¤é¡¹ç›®å…³è”çš„æ–‡ä»¶
                    const fileIndex = fileStore.index('projectId');
                    const fileRequest = fileIndex.openCursor(IDBKeyRange.only(projectId));
                    
                    fileRequest.onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            cursor.delete();
                            cursor.continue();
                        }
                    };
                    
                    // åˆ é™¤é¡¹ç›®å…³è”çš„èµ„æº
                    const resourceIndex = resourceStore.index('projectId');
                    const resourceRequest = resourceIndex.openCursor(IDBKeyRange.only(projectId));
                    
                    resourceRequest.onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            cursor.delete();
                            cursor.continue();
                        }
                    };
                    
                    transaction.oncomplete = function() {
                        resolve();
                    };
                    
                    transaction.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function saveFileToDB(projectId, filename, content, type) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([FILE_STORE], 'readwrite');
                    const store = transaction.objectStore(FILE_STORE);
                    
                    // å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
                    const index = store.index('projectId');
                    const request = index.openCursor(IDBKeyRange.only(projectId));
                    
                    let fileExists = false;
                    let fileId = null;
                    
                    request.onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.name === filename) {
                                fileExists = true;
                                fileId = cursor.value.id;
                            }
                            cursor.continue();
                        } else {
                            // éå†å®Œæˆ
                            const fileData = {
                                projectId: projectId,
                                name: filename,
                                content: content,
                                type: type,
                                updatedAt: new Date().toISOString()
                            };
                            
                            if (fileExists) {
                                // æ›´æ–°ç°æœ‰æ–‡ä»¶
                                fileData.id = fileId;
                                const updateRequest = store.put(fileData);
                                
                                updateRequest.onsuccess = function() {
                                    resolve();
                                };
                                
                                updateRequest.onerror = function(event) {
                                    reject(event.target.error);
                                };
                            } else {
                                // æ·»åŠ æ–°æ–‡ä»¶
                                const addRequest = store.add(fileData);
                                
                                addRequest.onsuccess = function() {
                                    resolve();
                                };
                                
                                addRequest.onerror = function(event) {
                                    reject(event.target.error);
                                };
                            }
                        }
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function saveResourceToDB(projectId, filename, content, type) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([RESOURCE_STORE], 'readwrite');
                    const store = transaction.objectStore(RESOURCE_STORE);
                    
                    // å…ˆæ£€æŸ¥èµ„æºæ˜¯å¦å·²å­˜åœ¨
                    const index = store.index('projectId');
                    const request = index.openCursor(IDBKeyRange.only(projectId));
                    
                    let resourceExists = false;
                    let resourceId = null;
                    
                    request.onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.name === filename) {
                                resourceExists = true;
                                resourceId = cursor.value.id;
                            }
                            cursor.continue();
                        } else {
                            // éå†å®Œæˆ
                            const resourceData = {
                                projectId: projectId,
                                name: filename,
                                content: content,
                                type: type,
                                updatedAt: new Date().toISOString()
                            };
                            
                            if (resourceExists) {
                                // æ›´æ–°ç°æœ‰èµ„æº
                                resourceData.id = resourceId;
                                const updateRequest = store.put(resourceData);
                                
                                updateRequest.onsuccess = function() {
                                    resolve();
                                };
                                
                                updateRequest.onerror = function(event) {
                                    reject(event.target.error);
                                };
                            } else {
                                // æ·»åŠ æ–°èµ„æº
                                const addRequest = store.add(resourceData);
                                
                                addRequest.onsuccess = function() {
                                    resolve();
                                };
                                
                                addRequest.onerror = function(event) {
                                    reject(event.target.error);
                                };
                            }
                        }
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function getFilesFromDB(projectId) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([FILE_STORE], 'readonly');
                    const store = transaction.objectStore(FILE_STORE);
                    
                    const index = store.index('projectId');
                    const request = index.getAll(IDBKeyRange.only(projectId));
                    
                    request.onsuccess = function() {
                        resolve(request.result);
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            function getResourcesFromDB(projectId) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([RESOURCE_STORE], 'readonly');
                    const store = transaction.objectStore(RESOURCE_STORE);
                    
                    const index = store.index('projectId');
                    const request = index.getAll(IDBKeyRange.only(projectId));
                    
                    request.onsuccess = function() {
                        resolve(request.result);
                    };
                    
                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }
            
            // é¡¹ç›®æ“ä½œå‡½æ•°
            function saveCurrentProject() {
                if (!currentProjectId) return;
                
                // ä¿å­˜HTMLã€CSSã€JSæ–‡ä»¶å†…å®¹
                const htmlContent = htmlEditor.getValue();
                const cssContent = cssEditor.getValue();
                const jsContent = jsEditor.getValue();
                
                Promise.all([
                    saveFileToDB(currentProjectId, 'index.html', htmlContent, 'html'),
                    saveFileToDB(currentProjectId, 'style.css', cssContent, 'css'),
                    saveFileToDB(currentProjectId, 'script.js', jsContent, 'js')
                ]).then(() => {
                    // æ›´æ–°é¡¹ç›®æ›´æ–°æ—¶é—´
                    return getProjectFromDB(currentProjectId).then(project => {
                        project.updatedAt = new Date().toISOString();
                        return updateProjectInDB(currentProjectId, project);
                    });
                }).then(() => {
                    console.log('é¡¹ç›®å·²è‡ªåŠ¨ä¿å­˜');
                }).catch(error => {
                    console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                });
            }
            
            function loadProjectFromDB(projectId) {
                return new Promise((resolve, reject) => {
                    currentProjectId = projectId;
                    
                    // è·å–é¡¹ç›®æ–‡ä»¶
                    getFilesFromDB(projectId).then(files => {
                        // æ¸…ç©ºå½“å‰æ–‡ä»¶èµ„æºç®¡ç†å™¨
                        const fileExplorer = document.getElementById('file-explorer');
                        const mainFolder = fileExplorer.querySelector('.folder-contents');
                        const resourcesFolder = fileExplorer.querySelectorAll('.folder-contents')[1];
                        
                        mainFolder.innerHTML = '';
                        resourcesFolder.innerHTML = '';
                        
                        // åŠ è½½æ–‡ä»¶
                        let htmlLoaded = false;
                        let cssLoaded = false;
                        let jsLoaded = false;
                        
                        files.forEach(file => {
                            // æ·»åŠ åˆ°æ–‡ä»¶èµ„æºç®¡ç†å™¨
                            const fileElement = document.createElement('div');
                            fileElement.className = 'file';
                            fileElement.dataset.type = file.type;
                            
                            fileElement.innerHTML = `
                                <i class="fas fa-file-code file-icon"></i>
                                <span class="file-name">${file.name}</span>
                                <div class="file-actions">
                                    <button title="é‡å‘½å"><i class="fas fa-pen"></i></button>
                                    <button title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                                </div>
                            `;
                            
                            // æ·»åŠ åˆ°ä¸»æ–‡ä»¶å¤¹æˆ–èµ„æºæ–‡ä»¶å¤¹
                            if (file.name === 'index.html' || file.name === 'style.css' || file.name === 'script.js') {
                                mainFolder.appendChild(fileElement);
                                
                                // è®¾ç½®ç¼–è¾‘å™¨å†…å®¹
                                if (file.name === 'index.html') {
                                    htmlEditor.setValue(file.content);
                                    htmlLoaded = true;
                                } else if (file.name === 'style.css') {
                                    cssEditor.setValue(file.content);
                                    cssLoaded = true;
                                } else if (file.name === 'script.js') {
                                    jsEditor.setValue(file.content);
                                    jsLoaded = true;
                                }
                            } else {
                                resourcesFolder.parentElement.parentElement.classList.add('open');
                                resourcesFolder.appendChild(fileElement);
                            }
                            
                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            fileElement.addEventListener('click', function(e) {
                                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') {
                                    return;
                                }
                                
                                document.querySelectorAll('.file').forEach(f => f.classList.remove('active'));
                                fileElement.classList.add('active');
                                
                                // å¦‚æœæ˜¯ä»£ç æ–‡ä»¶ï¼ŒåŠ è½½åˆ°ç¼–è¾‘å™¨ä¸­
                                if (file.type === 'html') {
                                    htmlEditor.setValue(file.content);
                                    tabs.forEach(t => t.classList.remove('active'));
                                    tabs[0].classList.add('active');
                                    editors.forEach(editor => editor.getWrapperElement().style.display = 'none');
                                    htmlEditor.getWrapperElement().style.display = 'block';
                                    htmlEditor.refresh();
                                } else if (file.type === 'css') {
                                    cssEditor.setValue(file.content);
                                    tabs.forEach(t => t.classList.remove('active'));
                                    tabs[1].classList.add('active');
                                    editors.forEach(editor => editor.getWrapperElement().style.display = 'none');
                                    cssEditor.getWrapperElement().style.display = 'block';
                                    cssEditor.refresh();
                                } else if (file.type === 'js') {
                                    jsEditor.setValue(file.content);
                                    tabs.forEach(t => t.classList.remove('active'));
                                    tabs[2].classList.add('active');
                                    editors.forEach(editor => editor.getWrapperElement().style.display = 'none');
                                    jsEditor.getWrapperElement().style.display = 'block';
                                    jsEditor.refresh();
                                }
                                
                                statusBar.textContent = 'å·²é€‰æ‹©: ' + file.name;
                            });
                        });
                        
                        // å¦‚æœæ²¡æœ‰åŠ è½½é»˜è®¤æ–‡ä»¶ï¼Œè®¾ç½®é»˜è®¤å†…å®¹
                        if (!htmlLoaded) {
                            htmlEditor.setValue('<!DOCTYPE html>\n<html>\n<head>\n    <title>æ–°é¡¹ç›®</title>\n</head>\n<body>\n    \n</body>\n</html>');
                        }
                        if (!cssLoaded) {
                            cssEditor.setValue('/* æ ·å¼è¡¨ */');
                        }
                        if (!jsLoaded) {
                            jsEditor.setValue('// JavaScriptä»£ç ');
                        }
                        
                        // åŠ è½½èµ„æºæ–‡ä»¶
                        return getResourcesFromDB(projectId);
                    }).then(resources => {
                        // æ¸…ç©ºå¯¼å…¥çš„èµ„æº
                        Object.keys(importedResources).forEach(key => {
                            delete importedResources[key];
                        });
                        
                        // åŠ è½½èµ„æº
                        resources.forEach(resource => {
                            importedResources[resource.name] = resource.content;
                        });
                        
                        // è¿è¡Œä»£ç ä»¥æ›´æ–°é¢„è§ˆ
                        runCode();
                        
                        resolve();
                    }).catch(error => {
                        reject(error);
                    });
                });
            }
            
            function loadProjectsList() {
                getAllProjectsFromDB().then(projects => {
                    projectList.innerHTML = '';
                    
                    if (projects.length === 0) {
                        projectList.innerHTML = '<option value="" disabled>æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®</option>';
                        return;
                    }
                    
                    // æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åº
                    projects.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.name} (${new Date(project.updatedAt).toLocaleDateString()})`;
                        projectList.appendChild(option);
                    });
                    
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé¡¹ç›®
                    if (projects.length > 0) {
                        projectList.value = projects[0].id;
                        projectInfo.value = `åç§°: ${projects[0].name}\næè¿°: ${projects[0].description || 'æ— '}\nåˆ›å»ºæ—¶é—´: ${new Date(projects[0].createdAt).toLocaleString()}\næ›´æ–°æ—¶é—´: ${new Date(projects[0].updatedAt).toLocaleString()}`;
                    }
                }).catch(error => {
                    console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                    projectList.innerHTML = '<option value="" disabled>åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥</option>';
                });
            }
            
            // åˆå§‹åŒ–æ•°æ®åº“å¹¶åŠ è½½é»˜è®¤é¡¹ç›®
            initDB().then(() => {
                // æ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªé»˜è®¤é¡¹ç›®
                getAllProjectsFromDB().then(projects => {
                    if (projects.length === 0) {
                        // åˆ›å»ºé»˜è®¤é¡¹ç›®
                        const defaultProject = {
                            name: 'é»˜è®¤é¡¹ç›®',
                            description: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„é»˜è®¤é¡¹ç›®',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        saveProjectToDB(defaultProject).then(projectId => {
                            currentProjectId = projectId;
                            // ä¿å­˜é»˜è®¤æ–‡ä»¶å†…å®¹
                            saveCurrentProject();
                        });
                    } else {
                        // åŠ è½½æœ€æ–°çš„é¡¹ç›®
                        const latestProject = projects.reduce((prev, current) => {
                            return (new Date(prev.updatedAt) > new Date(current.updatedAt)) ? prev : current;
                        });
                        
                        currentProjectId = latestProject.id;
                        loadProjectFromDB(latestProject.id);
                    }
                });

                // æ–°å»ºæ–‡ä»¶/æ–‡ä»¶å¤¹åŠŸèƒ½
                const newFileBtn = document.getElementById('new-file-btn');
                const newFolderBtn = document.getElementById('new-folder-btn');
                const newItemModal = document.getElementById('new-item-modal');
                const closeNewItemModal = document.getElementById('close-new-item-modal');
                const cancelNewItem = document.getElementById('cancel-new-item');
                const confirmNewItem = document.getElementById('confirm-new-item');
                const newItemName = document.getElementById('new-item-name');
                const newItemType = document.getElementById('new-item-type');
                const newItemTypeContainer = document.getElementById('new-item-type-container');
                const newItemTitle = document.getElementById('new-item-title');
                
                let currentNewItemType = 'file'; // 'file' æˆ– 'folder'
                
                newFileBtn.addEventListener('click', () => {
                    currentNewItemType = 'file';
                    newItemTitle.textContent = 'æ–°å»ºæ–‡ä»¶';
                    newItemTypeContainer.style.display = 'block';
                    newItemModal.style.display = 'flex';
                    newItemName.focus();
                });
                
                closeNewItemModal.addEventListener('click', () => {
                    newItemModal.style.display = 'none';
                });
                
                cancelNewItem.addEventListener('click', () => {
                    newItemModal.style.display = 'none';
                });
                
                confirmNewItem.addEventListener('click', () => {
                    const name = newItemName.value.trim();
                    
                    if (!name) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åç§°ï¼');
                        return;
                    }
                    
                    if (currentNewItemType === 'file') {
                        const type = newItemType.value;
                        const filename = name + '.' + type;
                        
                        // åˆ›å»ºæ–°æ–‡ä»¶
                        addFileToExplorer(filename, type);
                        
                        // å¦‚æœæ˜¯å½“å‰ç±»å‹çš„æ–‡ä»¶ï¼Œæ¸…ç©ºç¼–è¾‘å™¨
                        if ((type === 'html' && htmlEditor.getWrapperElement().style.display !== 'none') ||
                            (type === 'css' && cssEditor.getWrapperElement().style.display !== 'none') ||
                            (type === 'js' && jsEditor.getWrapperElement().style.display !== 'none')) {
                            
                            if (type === 'html') {
                                htmlEditor.setValue('<!DOCTYPE html>\n<html>\n<head>\n    <title>' + name + '</title>\n</head>\n<body>\n    \n</body>\n</html>');
                            } else if (type === 'css') {
                                cssEditor.setValue('/* ' + name + ' */');
                            } else {
                                jsEditor.setValue('// ' + name);
                            }
                        }
                        
                        statusBar.textContent = `å·²åˆ›å»ºæ–°æ–‡ä»¶: ${filename}`;
                    } else {
                        
                        const folderElement = document.createElement('div');
                        folderElement.className = 'folder';
                        
                        folderElement.innerHTML = `
                            <div class="folder-header">
                                <i class="fas fa-folder folder-icon"></i>
                                <span class="folder-name">${name}</span>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="folder-contents"></div>
                        `;
                        
                        fileExplorer.insertBefore(folderElement, fileExplorer.querySelector('.add-btn'));
                        
                        // æ·»åŠ æ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶
                        const folderHeader = folderElement.querySelector('.folder-header');
                        folderHeader.addEventListener('click', () => {
                            const parentFolder = folderHeader.parentElement;
                            parentFolder.classList.toggle('open');
                            
                            const icon = folderHeader.querySelector('.fa-chevron-right, .fa-chevron-down');
                            if (icon.classList.contains('fa-chevron-right')) {
                                icon.classList.remove('fa-chevron-right');
                                icon.classList.add('fa-chevron-down');
                            } else {
                                icon.classList.remove('fa-chevron-down');
                                icon.classList.add('fa-chevron-right');
                            }
                        });
                    }
                    
                    newItemModal.style.display = 'none';
                    newItemName.value = '';
                });
                
                // åˆå§‹è¿è¡Œ
                runCode();
                
                // ç§»åŠ¨ç«¯æ£€æµ‹
                function checkMobile() {
                    return window.innerWidth <= 768;
                }
                
                // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œé»˜è®¤å…³é—­ä¾§è¾¹æ 
                if (checkMobile()) {
                    sidebar.classList.remove('open');
                }
                
                // çª—å£å¤§å°æ”¹å˜æ—¶æ£€æŸ¥
                window.addEventListener('resize', () => {
                    if (!checkMobile()) {
                        sidebar.classList.add('open');
                    }
                });
            }).catch(error => {
                console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
                statusBar.textContent = 'æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ' + error.message;
            });
        });
    </script>
</body>
</html>